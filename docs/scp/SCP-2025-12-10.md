# Sprint Change Proposal: SCP-2025-12-10

## Quotation Modification & Tenant Conversion Workflow

**Date:** December 10, 2025
**Status:** Approved & Implemented
**Priority:** High

---

## Overview

This SCP introduces changes to the quotation modification workflow and tenant onboarding process, including AWS Textract integration for cheque OCR and streamlined wizard steps.

---

## Changes

### Change 1: Allow Quotation Modifications After SENT Status

**Problem:**
Currently, quotations become read-only after being sent. Business needs to modify quotations even after sending to accommodate customer negotiations.

**Solution:**
- Allow editing of quotations in DRAFT, SENT, and ACCEPTED statuses
- Block editing only for CONVERTED, REJECTED, and EXPIRED statuses
- Track modifications with a simple `isModified: boolean` field
- Display "Modified" badge on quotations that were edited after being sent

**Files Modified:**
- `backend/src/main/java/com/ultrabms/entity/Quotation.java`
  - Added `isModified` field (Boolean, default false)
  - Added `convertedTenantId` field (UUID)
  - Added `convertedAt` field (LocalDateTime)
- `backend/src/main/java/com/ultrabms/service/impl/QuotationServiceImpl.java`
  - Updated `updateQuotation()` to set `isModified = true` for non-DRAFT status
  - Added `markAsConverted()` method implementation
- `backend/src/main/java/com/ultrabms/service/QuotationService.java`
  - Added `markAsConverted(UUID quotationId, UUID tenantId)` interface method
- `backend/src/main/java/com/ultrabms/dto/quotations/QuotationResponse.java`
  - Added `isModified`, `convertedTenantId`, `convertedAt` fields
- `frontend/src/app/(dashboard)/quotations/[id]/page.tsx`
  - Edit button now shows for DRAFT, SENT, ACCEPTED (not just DRAFT)
  - Added "Modified" badge display
  - Convert to Tenant button shows for SENT and ACCEPTED
- `frontend/src/app/(dashboard)/quotations/[id]/edit/page.tsx`
  - Changed validation to allow editing for DRAFT, SENT, ACCEPTED
  - Block editing for CONVERTED, REJECTED, EXPIRED
  - Updated tips section
- `frontend/src/types/quotations.ts`
  - Added `isModified`, `convertedTenantId`, `convertedAt` to Quotation interface

---

### Change 2: Redesign Tenant Onboarding Step 3 - Financial Info & Cheque Upload

**Problem:**
Current Step 3 (Rent Breakdown) and Step 4 (Parking) are separate but related. Cheque details need to be captured with OCR support for efficiency.

**Solution:**
- Combine rent breakdown and cheque details into single "Financial Info" step
- Remove Step 4 (Parking Allocation) - parking is already handled in quotation
- Reduce wizard from 6 steps to 5 steps
- Integrate AWS Textract for cheque OCR (using Mumbai region `ap-south-1`)

**New Wizard Steps:**
1. Personal Info - Basic tenant details
2. Lease Info - Property & lease terms
3. Financial - Cheques & payment (NEW - combines old Steps 3 & 4)
4. Documents - Upload files
5. Review - Final review

**Files Created:**
- `backend/src/main/java/com/ultrabms/config/TextractConfig.java`
  - AWS Textract configuration using Mumbai region (ap-south-1)
- `backend/src/main/java/com/ultrabms/dto/textract/ChequeDetailResponse.java`
  - DTO for extracted cheque details
- `backend/src/main/java/com/ultrabms/dto/textract/ProcessChequesRequest.java`
  - DTO for cheque processing request
- `backend/src/main/java/com/ultrabms/dto/textract/ProcessChequesResponse.java`
  - DTO for cheque processing response
- `backend/src/main/java/com/ultrabms/service/TextractService.java`
  - Service interface for Textract operations
- `backend/src/main/java/com/ultrabms/service/impl/TextractServiceImpl.java`
  - Implementation with UAE bank cheque pattern matching
- `backend/src/main/java/com/ultrabms/controller/TextractController.java`
  - REST endpoints for cheque processing
- `frontend/src/services/textract.service.ts`
  - Frontend service for Textract API calls
- `frontend/src/components/tenants/FinancialInfoStep.tsx`
  - New combined financial info step component

**Files Modified:**
- `frontend/src/app/(dashboard)/tenants/create/page.tsx`
  - Updated from 6 to 5 steps
  - Replaced `rentBreakdown` and `parkingAllocation` with `financialInfo`
  - Updated step handlers and navigation
  - Updated financial summary sidebar

**AWS Configuration:**
```java
Region: ap-south-1 (Mumbai)
Reason: AWS Textract not available in UAE region
```

---

### Change 3: Bank Account Management

**Status:** Already exists - no changes needed

---

### Change 4: Set Quotation Status to CONVERTED After Tenant Onboarding

**Problem:**
After converting a quotation to a tenant, the quotation should be marked as CONVERTED and become non-editable.

**Solution:**
- After successful tenant creation, call `quotationService.markAsConverted()`
- Store reference to created tenant in quotation
- CONVERTED status blocks all further edits

**Files Modified:**
- `backend/src/main/java/com/ultrabms/service/impl/TenantServiceImpl.java`
  - Added QuotationService dependency injection
  - Added `quotationService.markAsConverted()` call in both `createTenant` methods
  - Call only executes when `request.getQuotationId()` is not null

---

## Database Changes

### Migration File: `V67__add_quotation_modification_tracking.sql`

### New Columns in `quotations` table:
```sql
-- Track if quotation was modified after being sent
ALTER TABLE quotations ADD COLUMN is_modified BOOLEAN DEFAULT FALSE;

-- Track conversion to tenant
ALTER TABLE quotations ADD COLUMN converted_tenant_id UUID;
ALTER TABLE quotations ADD COLUMN converted_at TIMESTAMP;

-- Foreign key to tenants table
ALTER TABLE quotations ADD CONSTRAINT fk_quotation_converted_tenant
    FOREIGN KEY (converted_tenant_id) REFERENCES tenants(id) ON DELETE SET NULL;
```

### Indexes:
```sql
-- Index for faster lookup by converted tenant
CREATE INDEX idx_quotations_converted_tenant_id ON quotations(converted_tenant_id);

-- Index for finding modified quotations
CREATE INDEX idx_quotations_is_modified ON quotations(is_modified) WHERE is_modified = TRUE;
```

---

## API Changes

### New Endpoint: Process Cheques with OCR
```
POST /api/textract/process-cheques
Content-Type: multipart/form-data

Request:
- chequeImages: MultipartFile[] (1-12 cheque images)

Response:
{
  "success": true,
  "cheques": [
    {
      "chequeNumber": "000123",
      "amount": 5000.00,
      "bankName": "Emirates NBD",
      "accountNumber": "1234567890",
      "date": "2025-02-01",
      "confidence": 0.95
    }
  ],
  "totalAmount": 60000.00,
  "processedCount": 12
}
```

---

## Testing Checklist

- [ ] Edit DRAFT quotation - should work
- [ ] Edit SENT quotation - should work, mark as modified
- [ ] Edit ACCEPTED quotation - should work, mark as modified
- [ ] Edit CONVERTED quotation - should be blocked
- [ ] Edit REJECTED quotation - should be blocked
- [ ] Edit EXPIRED quotation - should be blocked
- [ ] "Modified" badge appears on edited sent quotations
- [ ] Tenant wizard has 5 steps (not 6)
- [ ] Financial step captures cheque details
- [ ] Cheque OCR processes images (requires AWS credentials)
- [ ] Converting quotation to tenant marks quotation as CONVERTED
- [ ] Converted quotation shows tenant reference

---

## Rollback Plan

1. Revert entity changes (remove `isModified`, `convertedTenantId`, `convertedAt`)
2. Revert QuotationServiceImpl changes
3. Revert TenantServiceImpl changes
4. Revert frontend UI changes to show Edit only for DRAFT
5. Remove Textract service and related files
6. Revert tenant wizard to 6 steps

---

## Dependencies

- AWS SDK v2 for Java
- AWS Textract service access (Mumbai region)
- Valid AWS credentials with Textract permissions

---

## Notes

- AWS Textract is not available in UAE region, so Mumbai (ap-south-1) is used
- Cheque OCR uses regex pattern matching for UAE bank cheque formats
- The `isModified` flag is simple boolean tracking (no version history)
