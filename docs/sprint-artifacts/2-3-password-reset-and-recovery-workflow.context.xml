<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Password Reset and Recovery Workflow</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-3-password-reset-and-recovery-workflow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to reset my password if I forget it</iWant>
    <soThat>I can regain access to my account securely</soThat>
    <tasks>
      <!-- Task 1: Create Password Reset Tokens Database Schema -->
      <task id="1" acs="4">
        <title>Create Password Reset Tokens Database Schema</title>
        <subtasks>
          <subtask>Create Flyway migration V13__create_password_reset_tokens_table.sql</subtask>
          <subtask>Define table schema with id, user_id, token, expires_at, used, created_at columns</subtask>
          <subtask>Create indexes on token and expires_at columns</subtask>
          <subtask>Add foreign key constraint with ON DELETE CASCADE to users table</subtask>
          <subtask>Test migration runs successfully on local database</subtask>
        </subtasks>
      </task>

      <!-- Task 2: Create Password Reset Tokens JPA Entity -->
      <task id="2" acs="4">
        <title>Create Password Reset Tokens JPA Entity</title>
        <subtasks>
          <subtask>Create PasswordResetToken entity with fields and validation annotations</subtask>
          <subtask>Add isExpired() and isValid() helper methods</subtask>
          <subtask>Create PasswordResetTokenRepository with custom query methods</subtask>
        </subtasks>
      </task>

      <!-- Task 3: Create Rate Limiting Table and Repository -->
      <task id="3" acs="7">
        <title>Create Rate Limiting Table and Repository</title>
        <subtasks>
          <subtask>Create Flyway migration V14__create_password_reset_attempts_table.sql</subtask>
          <subtask>Create PasswordResetAttempt entity</subtask>
          <subtask>Create PasswordResetAttemptRepository</subtask>
        </subtasks>
      </task>

      <!-- Task 4: Configure Spring Mail -->
      <task id="4" acs="5">
        <title>Configure Spring Mail</title>
        <subtasks>
          <subtask>Add spring-boot-starter-mail dependency to pom.xml</subtask>
          <subtask>Configure SMTP settings in application-dev.yml</subtask>
          <subtask>Create EmailConfig class with @EnableAsync annotation</subtask>
          <subtask>Configure ThreadPoolTaskExecutor bean for async email sending</subtask>
          <subtask>Test SMTP connection on application startup</subtask>
        </subtasks>
      </task>

      <!-- Task 5: Create Email Templates -->
      <task id="5" acs="6">
        <title>Create Email Templates</title>
        <subtasks>
          <subtask>Create resources/templates/email/ directory</subtask>
          <subtask>Create password-reset-email.html Thymeleaf template with branding</subtask>
          <subtask>Create password-change-confirmation.html template</subtask>
          <subtask>Create plain text versions for both templates</subtask>
          <subtask>Test templates render correctly with sample data</subtask>
        </subtasks>
      </task>

      <!-- Task 6: Implement Email Service -->
      <task id="6" acs="5,6">
        <title>Implement Email Service</title>
        <subtasks>
          <subtask>Create EmailService class with JavaMailSender and TemplateEngine injection</subtask>
          <subtask>Implement sendPasswordResetEmail() method with @Async annotation</subtask>
          <subtask>Implement sendPasswordChangeConfirmation() method</subtask>
          <subtask>Add error handling and retry logic</subtask>
        </subtasks>
      </task>

      <!-- Task 7: Create Password Validator Utility -->
      <task id="7" acs="12">
        <title>Create Password Validator Utility</title>
        <subtasks>
          <subtask>Create PasswordValidator utility class with validation logic</subtask>
          <subtask>Define password requirements constants and regex pattern</subtask>
          <subtask>Implement validate() method returning ValidationResult</subtask>
          <subtask>Add unit tests for validator</subtask>
        </subtasks>
      </task>

      <!-- Task 8: Implement Password Reset Request Endpoint -->
      <task id="8" acs="1,7,9">
        <title>Implement Password Reset Request Endpoint</title>
        <subtasks>
          <subtask>Create PasswordResetService with initiatePasswordReset() method</subtask>
          <subtask>Implement rate limiting logic</subtask>
          <subtask>Generate secure tokens and save to database</subtask>
          <subtask>Send password reset email asynchronously</subtask>
          <subtask>Create AuthController POST /api/v1/auth/forgot-password endpoint</subtask>
          <subtask>Create ForgotPasswordRequest DTO and exception handlers</subtask>
        </subtasks>
      </task>

      <!-- Task 9: Implement Token Validation Endpoint -->
      <task id="9" acs="2">
        <title>Implement Token Validation Endpoint</title>
        <subtasks>
          <subtask>Implement validateResetToken() in PasswordResetService</subtask>
          <subtask>Create TokenValidationResult record</subtask>
          <subtask>Create AuthController GET /api/v1/auth/reset-password/validate endpoint</subtask>
        </subtasks>
      </task>

      <!-- Task 10: Implement Password Reset Completion Endpoint -->
      <task id="10" acs="3,9,12">
        <title>Implement Password Reset Completion Endpoint</title>
        <subtasks>
          <subtask>Implement resetPassword() in PasswordResetService</subtask>
          <subtask>Validate token and new password</subtask>
          <subtask>Hash password with BCrypt and update user</subtask>
          <subtask>Mark token as used and delete refresh tokens</subtask>
          <subtask>Send confirmation email and log to audit</subtask>
          <subtask>Create AuthController POST /api/v1/auth/reset-password endpoint</subtask>
          <subtask>Create ResetPasswordRequest DTO and exception handlers</subtask>
        </subtasks>
      </task>

      <!-- Task 11: Implement Token Cleanup Scheduled Job -->
      <task id="11" acs="8">
        <title>Implement Token Cleanup Scheduled Job</title>
        <subtasks>
          <subtask>Create PasswordResetCleanupService</subtask>
          <subtask>Implement cleanupExpiredTokens() with @Scheduled annotation</subtask>
          <subtask>Delete expired and old used tokens</subtask>
          <subtask>Add @Transactional annotation</subtask>
          <subtask>Test scheduled job execution</subtask>
        </subtasks>
      </task>

      <!-- Task 12: Create Frontend Forgot Password Page -->
      <task id="12" acs="10">
        <title>Create Frontend Forgot Password Page</title>
        <subtasks>
          <subtask>Create app/(auth)/forgot-password/page.tsx</subtask>
          <subtask>Build form with React Hook Form and Zod validation</subtask>
          <subtask>Implement onSubmit handler calling forgot-password API</subtask>
          <subtask>Style with shadcn/ui components</subtask>
          <subtask>Add link back to login page</subtask>
        </subtasks>
      </task>

      <!-- Task 13: Create Frontend Reset Password Page -->
      <task id="13" acs="11,12">
        <title>Create Frontend Reset Password Page</title>
        <subtasks>
          <subtask>Create app/(auth)/reset-password/page.tsx</subtask>
          <subtask>Extract token from URL and validate on mount</subtask>
          <subtask>Build password form with strength meter</subtask>
          <subtask>Implement countdown timer for token expiration</subtask>
          <subtask>Implement onSubmit handler calling reset-password API</subtask>
          <subtask>Style with shadcn components</subtask>
        </subtasks>
      </task>

      <!-- Task 14: Test Password Reset Flow End-to-End -->
      <task id="14" acs="all">
        <title>Test Password Reset Flow End-to-End</title>
        <subtasks>
          <subtask>Test happy path with valid email and password reset</subtask>
          <subtask>Test invalid email scenarios</subtask>
          <subtask>Test token expiration</subtask>
          <subtask>Test token reuse prevention</subtask>
          <subtask>Test rate limiting</subtask>
          <subtask>Test token invalidation on new request</subtask>
          <subtask>Test password validation rules</subtask>
          <subtask>Test refresh token invalidation</subtask>
          <subtask>Test audit logging</subtask>
        </subtasks>
      </task>

      <!-- Task 15: Update API Documentation -->
      <task id="15" acs="all">
        <title>Update API Documentation</title>
        <subtasks>
          <subtask>Add Swagger annotations to AuthController endpoints</subtask>
          <subtask>Update backend/README.md with Password Reset section</subtask>
          <subtask>Document email template customization process</subtask>
          <subtask>Add troubleshooting section</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" priority="high">
      <title>Password Reset Request Endpoint</title>
      <description>Create POST /api/v1/auth/forgot-password endpoint accepting { email } in request body. Validate email format using @Email annotation. Check if user exists in database with active account (is_active = true). Generate secure random token using SecureRandom (32 bytes, hex-encoded). Create password_reset_tokens table entry with userId, token, expiresAt (15 minutes from now), used (false), createdAt. If email doesn't exist, still return 200 OK with generic "check your email" message (security: don't reveal account existence). Send password reset email asynchronously with reset link. Return 200 OK: { success: true, message: "If account exists, password reset link sent to email" }.</description>
    </ac>

    <ac id="2" priority="high">
      <title>Password Reset Token Validation</title>
      <description>Create GET /api/v1/auth/reset-password/validate endpoint with query parameter ?token={token}. Query password_reset_tokens table for matching token. Validate: token exists, not expired (expiresAt > now), not used (used = false), associated user account is active. Return 200 OK if valid: { success: true, valid: true }. Return 400 Bad Request if invalid/expired: { success: false, error: { code: "INVALID_TOKEN", message: "Reset link is invalid or has expired" } }. Include remaining time until expiration in valid response.</description>
    </ac>

    <ac id="3" priority="high">
      <title>Password Reset Completion</title>
      <description>Create POST /api/v1/auth/reset-password endpoint accepting { token, newPassword }. Re-validate token (same checks as AC2). Validate newPassword meets requirements: min 8 characters, contains uppercase, lowercase, number, special character (same as registration). Hash password with BCrypt (cost factor 12). Update user.passwordHash in users table. Mark token as used (used = true) in password_reset_tokens. Invalidate all existing refresh tokens for user (delete from refresh_tokens table or mark invalid). Log password reset to audit_logs table with userId, action "PASSWORD_RESET", IP address. Send password change confirmation email. Return 200 OK: { success: true, message: "Password reset successful" }.</description>
    </ac>

    <ac id="4" priority="high">
      <title>Password Reset Tokens Database Schema</title>
      <description>Create password_reset_tokens table via Flyway migration V13__create_password_reset_tokens_table.sql with columns: id BIGSERIAL PRIMARY KEY, user_id BIGINT REFERENCES users(id) NOT NULL, token VARCHAR(255) UNIQUE NOT NULL, expires_at TIMESTAMP NOT NULL, used BOOLEAN DEFAULT false, created_at TIMESTAMP DEFAULT NOW(). Create index on token for fast lookup: idx_password_reset_tokens_token. Create index on expires_at for cleanup job: idx_password_reset_tokens_expires_at. Add constraint to prevent multiple active tokens per user (optional).</description>
    </ac>

    <ac id="5" priority="high">
      <title>Email Service Integration</title>
      <description>Configure Spring Mail in application.yml with SMTP settings (Gmail API or SMTP server). Create EmailService in com.ultrabms.service package with methods: sendPasswordResetEmail(User user, String resetToken) and sendPasswordChangeConfirmation(User user). Generate reset link: {FRONTEND_URL}/reset-password?token={token}. Email contains: branded HTML template, clear instructions, clickable reset link button, expiration warning (15 minutes), support contact, plain text fallback. Use Thymeleaf or similar for email templates. Send emails asynchronously using @Async to avoid blocking request.</description>
    </ac>

    <ac id="6" priority="medium">
      <title>Email Templates</title>
      <description>Create email templates in resources/templates/email/ directory: password-reset-email.html (reset link with 15-minute expiration notice, instructions, support contact) and password-change-confirmation.html (notification of successful password change, login link, security alert message). Include Ultra BMS branding: logo, colors (#0A2342 primary), footer with company info. Ensure responsive HTML (mobile-friendly). Include plain text alternatives for email clients that don't support HTML. Test templates render correctly in major email clients.</description>
    </ac>

    <ac id="7" priority="high">
      <title>Rate Limiting for Password Reset</title>
      <description>Implement rate limiting on POST /api/v1/auth/forgot-password endpoint: maximum 3 requests per hour per email address. Store rate limit data in password_reset_attempts table with columns: email, attempt_count, first_attempt_at, last_attempt_at. Increment attempt_count on each request, reset after 1 hour. Return 429 Too Many Requests if limit exceeded: { success: false, error: { code: "RATE_LIMIT_EXCEEDED", message: "Too many password reset attempts. Please try again in {minutes} minutes." } }. Include Retry-After header with seconds until retry allowed. Log rate limit violations to audit_logs.</description>
    </ac>

    <ac id="8" priority="medium">
      <title>Token Expiration and Cleanup</title>
      <description>Tokens expire 15 minutes after creation (expires_at = created_at + 15 minutes). Create scheduled job using @Scheduled(cron = "0 0 * * * *") to run hourly. Job deletes expired tokens from password_reset_tokens table where expires_at &lt; NOW() - 1 hour (keep recent for audit). Also delete old used tokens (>24 hours old). Log cleanup statistics (deleted count) at INFO level. Ensure job uses @Transactional for atomicity.</description>
    </ac>

    <ac id="9" priority="critical">
      <title>Security Measures</title>
      <description>When new reset requested for same email, invalidate all previous unused tokens for that user (set used = true or delete). Generate cryptographically secure tokens using java.security.SecureRandom. Tokens must be at least 32 bytes (256 bits) entropy, hex-encoded to 64 characters. Hash tokens before storing in database (optional enhancement for extra security). Log all password reset activities to audit_logs: request initiated, token validated, password changed, rate limit exceeded. Include userId (if exists), email, IP address, timestamp. Never expose sensitive information in error messages (e.g., "user not found").</description>
    </ac>

    <ac id="10" priority="medium">
      <title>Frontend Forgot Password Page</title>
      <description>Create app/(auth)/forgot-password/page.tsx with email input form. Use React Hook Form with Zod validation: email required and valid format. On submit, call POST /api/v1/auth/forgot-password. Show success message: "If your email is registered, you'll receive reset instructions shortly." Show error message for network failures. Include link back to login page. Style with shadcn/ui components (Card, Input, Button). Show loading state during API call. Display recaptcha or similar to prevent abuse (optional).</description>
    </ac>

    <ac id="11" priority="medium">
      <title>Frontend Reset Password Page</title>
      <description>Create app/(auth)/reset-password/page.tsx with query parameter token extraction. On page load, validate token by calling GET /api/v1/auth/reset-password/validate?token={token}. If token invalid/expired, show error message with link to request new reset. If valid, show new password form with two fields: newPassword and confirmPassword. Implement password strength meter (weak/medium/strong) showing requirements checklist. Use Zod validation: passwords match, meets complexity requirements. On submit, call POST /api/v1/auth/reset-password with { token, newPassword }. Show success message and redirect to login after 3 seconds. Include countdown timer showing token expiration (15 minutes from email sent).</description>
    </ac>

    <ac id="12" priority="high">
      <title>Password Strength Validation</title>
      <description>Frontend and backend validate password strength consistently. Requirements: minimum 8 characters, at least 1 uppercase letter (A-Z), at least 1 lowercase letter (a-z), at least 1 number (0-9), at least 1 special character (!@#$%^&*). Backend uses regex pattern validation in PasswordValidator utility class. Frontend shows real-time feedback: checklist of requirements with checkmarks as user types, overall strength indicator (weak/medium/strong), color-coded strength bar (red/yellow/green). Reject common passwords (optional: check against top 10000 common passwords list).</description>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- PRD Documentation -->
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document - Authentication Requirements</title>
        <section>3.1.1 Authentication & Access Control</section>
        <snippet>Password recovery workflow specified as 3-step process. Multi-factor authentication (MFA) support, Single Sign-On (SSO) support, session management and timeout controls, role-based access control (RBAC).</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document - Email Integration</title>
        <section>5.2 Integration Requirements</section>
        <snippet>Email Service: Gmail API for sending/receiving emails. Password reset notifications should use Gmail API via Spring Mail integration.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document - Security Requirements</title>
        <section>5.4 Security Requirements</section>
        <snippet>API Security: OAuth 2.0 with JWT tokens. Audit Logging: Comprehensive activity tracking. All password reset attempts must be logged in audit trails for security monitoring.</snippet>
      </doc>

      <!-- Architecture Documentation -->
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Authentication Module Mapping</title>
        <section>Epic to Architecture Mapping</section>
        <snippet>Backend Components: AuthController, UserService, JwtTokenProvider, SecurityConfig. Frontend Routes: /login, /forgot-password, /reset-password. Database Tables: users, roles, permissions. External Services: Email (Gmail API).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Async Processing Pattern</title>
        <section>Async Processing</section>
        <snippet>Use Spring @Async annotation for non-blocking operations. Pattern: @Async + @Scheduled for async operations. Usage: Notifications, Jobs, Reports. Email sending should be asynchronous to avoid blocking API responses.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - REST API Conventions</title>
        <section>REST API Conventions</section>
        <snippet>Base URL: /api/v1. Endpoints: Plural nouns, kebab-case. HTTP Methods: POST for creation. Status Codes: 200 OK (success), 400 Bad Request (validation), 401 Unauthorized, 429 Too Many Requests. Standard response format with success, data/error, timestamp fields.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Database Naming Conventions</title>
        <section>Database Schema Standards</section>
        <snippet>Tables: snake_case, plural (e.g., password_reset_tokens). Columns: snake_case (e.g., expires_at, created_at). Foreign Keys: {table}_id. Indexes: idx_{table}_{column}. All dates stored in UTC timezone using Java 17 java.time API.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Audit Logging Requirements</title>
        <section>Audit Logging</section>
        <snippet>All user actions logged to audit_logs table. Includes: user_id, action, entity, IP address, timestamp. Log sensitive operations: login, data access, modifications. Retention: 7 years (compliance requirement).</snippet>
      </doc>

      <!-- UX Design Documentation -->
      <doc>
        <path>docs/development/ux-design-specification.md</path>
        <title>UX Design - Component Library</title>
        <section>shadcn/ui Component Library Strategy</section>
        <snippet>Primary Framework: shadcn/ui with Tailwind CSS. Form Components: form, label, input, button, textarea, date-picker. Feedback: toast, alert, progress. Install core primitives first, then add form components for data entry flows.</snippet>
      </doc>
      <doc>
        <path>docs/development/ux-design-specification.md</path>
        <title>UX Design - Form Patterns</title>
        <section>Form Design Standards</section>
        <snippet>Validation Timing: On Blur (validate field when user leaves) + On Submit (final validation). Real-time for password strength. Error Display: Inline error message below field + red border on input. Required Field Indicator: Asterisk (*) in red next to label.</snippet>
      </doc>
      <doc>
        <path>docs/development/ux-design-specification.md</path>
        <title>UX Design - Feedback Patterns</title>
        <section>User Feedback and Notifications</section>
        <snippet>Success Feedback: Toast notification (top-right, auto-dismiss 4s) with green checkmark icon. Error Feedback: Inline validation (forms) + Alert (system errors). Loading States: Spinner on button during API call. Message Format: Clear, actionable, non-technical.</snippet>
      </doc>

      <!-- Epic Context -->
      <doc>
        <path>docs/epics/epic-2-authentication-user-management.md</path>
        <title>Epic 2 - Story 2.3: Password Reset and Recovery Workflow</title>
        <section>Story 2.3 Acceptance Criteria</section>
        <snippet>3-step workflow: (1) Request reset with email validation and token generation, (2) Validate token (15-minute expiration), (3) Set new password with BCrypt hashing. Includes email templates, rate limiting, audit logging, and refresh token invalidation.</snippet>
      </doc>
    </docs>

    <code>
      <!-- Existing Backend Code to Extend -->
      <artifact>
        <path>backend/src/main/java/com/ultrabms/controller/AuthController.java</path>
        <kind>controller</kind>
        <symbol>AuthController</symbol>
        <lines>1-100</lines>
        <reason>Existing authentication controller with /register and /login endpoints. Add password reset endpoints here: POST /forgot-password, GET /reset-password/validate, POST /reset-password. Follow established patterns for request/response handling, logging, and IP address extraction.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/java/com/ultrabms/entity/User.java</path>
        <kind>entity</kind>
        <symbol>User</symbol>
        <lines>1-80</lines>
        <reason>User entity with email, passwordHash, firstName, lastName, role, and active fields. Password reset will update the passwordHash field. User entity includes @JsonIgnore on passwordHash. Use existing BCrypt encoding pattern for password hashing.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/java/com/ultrabms/service/LoginAttemptService.java</path>
        <kind>service</kind>
        <symbol>LoginAttemptService</symbol>
        <lines>1-101</lines>
        <reason>Implements rate limiting pattern using Ehcache. Use similar approach for password reset rate limiting: @CachePut to record attempts, @Cacheable to check attempts, @CacheEvict to reset. MAX_ATTEMPTS = 3 for password reset (vs 5 for login). Cache TTL managed by ehcache.xml.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/java/com/ultrabms/service/AuthServiceImpl.java</path>
        <kind>service</kind>
        <symbol>AuthServiceImpl</symbol>
        <lines>unknown</lines>
        <reason>Existing authentication service implementation. Follow established patterns for password encoding (BCrypt), audit logging, token management, and exception handling. Service layer contains business logic, controllers delegate to services.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/java/com/ultrabms/repository/UserRepository.java</path>
        <kind>repository</kind>
        <symbol>UserRepository</symbol>
        <lines>unknown</lines>
        <reason>JPA repository for User entity. Use existing findByEmail(String email) method to lookup users for password reset. Follow JpaRepository pattern for creating PasswordResetTokenRepository.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/java/com/ultrabms/repository/AuditLogRepository.java</path>
        <kind>repository</kind>
        <symbol>AuditLogRepository</symbol>
        <lines>unknown</lines>
        <reason>Repository for audit logging. Log all password reset activities: PASSWORD_RESET_REQUESTED, PASSWORD_RESET_COMPLETED. Include userId, email, IP address, timestamp. Follow existing audit log patterns from authentication.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/java/com/ultrabms/repository/TokenBlacklistRepository.java</path>
        <kind>repository</kind>
        <symbol>TokenBlacklistRepository</symbol>
        <lines>unknown</lines>
        <reason>Pattern for token management. Use similar approach for PasswordResetTokenRepository with custom queries: findByToken, deleteByExpiresAtBefore, findByUserIdAndUsedFalse.</reason>
      </artifact>

      <artifact>
        <path>backend/src/main/resources/application-dev.yml</path>
        <kind>config</kind>
        <symbol>application-dev.yml</symbol>
        <lines>1-100</lines>
        <reason>Development configuration. Add Spring Mail SMTP settings: spring.mail.host, port, username, password. Configure async executor for @Async email sending. Add frontend URL for reset link generation. Gmail API credentials via environment variables.</reason>
      </artifact>

      <!-- Frontend Structure -->
      <artifact>
        <path>frontend/src/app/layout.tsx</path>
        <kind>layout</kind>
        <symbol>RootLayout</symbol>
        <lines>unknown</lines>
        <reason>Next.js root layout. Existing layout structure for app router. Create new (auth) route group for authentication pages to share layout/styling patterns.</reason>
      </artifact>

      <artifact>
        <path>frontend/package.json</path>
        <kind>config</kind>
        <symbol>package.json</symbol>
        <lines>20-32</lines>
        <reason>Frontend dependencies. Has React Hook Form (@hookform/resolvers), Zod, Axios, Next.js 16. Need to add shadcn/ui components: npx shadcn@latest add card input button alert toast. Lucide React already available for icons.</reason>
      </artifact>
    </code>

    <dependencies>
      <backend>
        <framework>Spring Boot 3.4.0</framework>
        <dependencies>
          <dependency name="spring-boot-starter-web" usage="REST API framework" />
          <dependency name="spring-boot-starter-security" usage="Security and authentication" />
          <dependency name="spring-boot-starter-validation" usage="Bean validation (@Valid, @Email)" />
          <dependency name="spring-boot-starter-data-jpa" usage="Database access with Hibernate" />
          <dependency name="spring-boot-starter-cache" usage="Caching support" />
          <dependency name="spring-boot-starter-mail" usage="Email sending (NEED TO ADD)" required="true" />
          <dependency name="postgresql" version="runtime" usage="PostgreSQL JDBC driver" />
          <dependency name="flyway-core" usage="Database migrations" />
          <dependency name="ehcache" version="3.10.8" usage="Rate limiting cache" />
          <dependency name="jjwt-api" version="0.12.6" usage="JWT tokens" />
          <dependency name="lombok" version="1.18.36" usage="Boilerplate reduction" />
          <dependency name="passay" version="1.6.5" usage="Password strength validation" />
          <dependency name="springdoc-openapi-starter-webmvc-ui" version="2.8.4" usage="Swagger/OpenAPI documentation" />
        </dependencies>
      </backend>
      <frontend>
        <framework>Next.js 16.0.2 (React 19.2.0)</framework>
        <dependencies>
          <dependency name="react-hook-form" version="^7.66.0" usage="Form state management" />
          <dependency name="@hookform/resolvers" version="^5.2.2" usage="Zod integration for RHF" />
          <dependency name="zod" version="^4.1.12" usage="Schema validation" />
          <dependency name="axios" version="^1.13.2" usage="HTTP client for API calls" />
          <dependency name="tailwindcss" version="^4" usage="Styling framework" />
          <dependency name="lucide-react" version="^0.553.0" usage="Icon library" />
          <dependency name="shadcn/ui" usage="UI components (Card, Input, Button, Alert, Toast)" required="true" install="npx shadcn@latest add card input button alert toast" />
        </dependencies>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <!-- Architectural Constraints -->
    <constraint type="architecture">
      <rule>Follow existing controller → service → repository layering pattern established in AuthController and AuthServiceImpl</rule>
      <rule>Use @RequiredArgsConstructor (Lombok) for constructor injection in all services and controllers</rule>
      <rule>Controllers handle HTTP concerns only (request/response, status codes); business logic resides in service layer</rule>
    </constraint>

    <!-- Database Constraints -->
    <constraint type="database">
      <rule>Use snake_case naming for all tables and columns (password_reset_tokens, expires_at, created_at)</rule>
      <rule>Create Flyway migrations with sequential versioning: V13__create_password_reset_tokens_table.sql, V14__create_password_reset_attempts_table.sql</rule>
      <rule>Add indexes on frequently queried columns: idx_password_reset_tokens_token, idx_password_reset_tokens_expires_at</rule>
      <rule>Use BIGSERIAL for primary keys, TIMESTAMP for date/time columns (stored in UTC)</rule>
      <rule>Foreign keys reference users(id) with ON DELETE CASCADE for data integrity</rule>
    </constraint>

    <!-- Security Constraints -->
    <constraint type="security">
      <rule>Generate tokens using java.security.SecureRandom with 32 bytes (256 bits) entropy, hex-encoded to 64 characters</rule>
      <rule>Hash passwords with BCrypt cost factor 12 using existing PasswordEncoder bean</rule>
      <rule>Never reveal user existence in error messages (always return 200 OK for forgot-password, even if email doesn't exist)</rule>
      <rule>Log ALL password reset activities to audit_logs table: PASSWORD_RESET_REQUESTED, PASSWORD_RESET_COMPLETED, RATE_LIMIT_EXCEEDED</rule>
      <rule>Include userId (if exists), email, IP address, timestamp in audit logs</rule>
      <rule>Invalidate all refresh tokens on password reset by deleting from refresh_tokens table (force re-authentication)</rule>
      <rule>Token expiration: 15 minutes from creation (expires_at = created_at + 15 minutes)</rule>
      <rule>Rate limiting: Maximum 3 password reset requests per hour per email address (429 Too Many Requests if exceeded)</rule>
    </constraint>

    <!-- API Constraints -->
    <constraint type="api">
      <rule>Follow REST conventions: Base URL /api/v1/auth, kebab-case endpoint names</rule>
      <rule>Use standard response format: { success: boolean, data/error: object, message: string, timestamp: ISO8601 }</rule>
      <rule>HTTP Status Codes: 200 (success), 400 (validation error), 401 (unauthorized), 429 (rate limit), 500 (server error)</rule>
      <rule>Add Swagger @Operation, @ApiResponses annotations to all endpoints for API documentation</rule>
      <rule>Use @Valid annotation for request body validation with Jakarta Bean Validation</rule>
    </constraint>

    <!-- Email Constraints -->
    <constraint type="email">
      <rule>Send emails asynchronously using Spring @Async annotation to avoid blocking API responses</rule>
      <rule>Configure Spring Mail with Gmail SMTP: host smtp.gmail.com, port 587, TLS enabled</rule>
      <rule>Use Thymeleaf templates for HTML emails with plain text fallback</rule>
      <rule>Include Ultra BMS branding: logo, colors (#0A2342 primary), footer with company info</rule>
      <rule>Email templates location: backend/src/main/resources/templates/email/</rule>
      <rule>Fail silently on email errors (log error, don't throw exception to user)</rule>
    </constraint>

    <!-- Frontend Constraints -->
    <constraint type="frontend">
      <rule>Use React Hook Form with Zod for all form validation (established pattern)</rule>
      <rule>Validate on blur (individual fields) + on submit (entire form). Real-time validation for password strength.</rule>
      <rule>Use shadcn/ui components: Card, Input, Button, Alert, Toast for consistent UI</rule>
      <rule>Show inline errors below input fields with red border on invalid inputs</rule>
      <rule>Success feedback: Toast notification (4s auto-dismiss, top-right) with success message</rule>
      <rule>Loading states: Spinner on button during API call ("Sending reset link...")</rule>
      <rule>Routes: Create app/(auth)/forgot-password/page.tsx and app/(auth)/reset-password/page.tsx</rule>
      <rule>Use Axios for API calls with error handling</rule>
    </constraint>

    <!-- Testing Constraints -->
    <constraint type="testing">
      <rule>Unit tests: Test PasswordValidator, token generation, email service (with mocks)</rule>
      <rule>Integration tests: Test all 3 endpoints with MockMvc, verify database state, audit logs</rule>
      <rule>E2E tests: Use Playwright to test complete flow from forgot-password page to login</rule>
      <rule>Test negative cases: expired tokens, used tokens, invalid passwords, rate limiting, non-existent emails</rule>
      <rule>Mock email sending in tests (use JavaMailSender mock)</rule>
    </constraint>

    <!-- Code Style Constraints -->
    <constraint type="style">
      <rule>Use Java 17 features: records for DTOs (ForgotPasswordRequest, ResetPasswordRequest), LocalDateTime for dates</rule>
      <rule>Use @Slf4j (Lombok) for logging, not System.out</rule>
      <rule>Follow existing DTO naming: *Request for input, *Response for output, *Dto for data transfer</rule>
      <rule>Create custom exceptions: InvalidTokenException, RateLimitExceededException extending RuntimeException</rule>
      <rule>Add GlobalExceptionHandler methods for new exceptions returning appropriate HTTP status codes</rule>
    </constraint>
  </constraints>

  <interfaces>
    <!-- Existing Authentication APIs (for reference) -->
    <interface>
      <name>User Registration API</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/auth/register</signature>
      <path>backend/src/main/java/com/ultrabms/controller/AuthController.java:49-68</path>
      <description>Existing registration endpoint. Password reset will reuse User entity, PasswordEncoder, and validation patterns from this endpoint.</description>
    </interface>

    <interface>
      <name>User Login API</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/auth/login</signature>
      <path>backend/src/main/java/com/ultrabms/controller/AuthController.java:78-100</path>
      <description>Existing login endpoint with rate limiting via LoginAttemptService. Password reset will follow similar pattern for IP extraction, audit logging, and rate limiting.</description>
    </interface>

    <!-- New Password Reset APIs (to be implemented) -->
    <interface>
      <name>Forgot Password API</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/auth/forgot-password</signature>
      <path>backend/src/main/java/com/ultrabms/controller/AuthController.java (NEW METHOD)</path>
      <request>{ "email": "user@example.com" }</request>
      <response>{ "success": true, "message": "If account exists, password reset link sent to email" }</response>
      <description>Request password reset. Accepts email, validates format, generates secure token, stores in database with 15-minute expiration, sends reset email asynchronously. Always returns 200 OK for security (don't reveal account existence). Implements rate limiting: 3 requests per hour per email.</description>
    </interface>

    <interface>
      <name>Validate Reset Token API</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/auth/reset-password/validate?token={token}</signature>
      <path>backend/src/main/java/com/ultrabms/controller/AuthController.java (NEW METHOD)</path>
      <request>Query parameter: token (String, 64-character hex)</request>
      <response>{ "success": true, "valid": true, "remainingMinutes": 12 }</response>
      <description>Validate reset token before showing password form. Checks token exists, not expired (&lt; 15 minutes old), not used, associated user account active. Returns remaining time until expiration. Returns 400 Bad Request if invalid.</description>
    </interface>

    <interface>
      <name>Reset Password API</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/auth/reset-password</signature>
      <path>backend/src/main/java/com/ultrabms/controller/AuthController.java (NEW METHOD)</path>
      <request>{ "token": "64-char-hex", "newPassword": "SecurePass123!" }</request>
      <response>{ "success": true, "message": "Password reset successful" }</response>
      <description>Complete password reset. Re-validates token, validates newPassword strength (8+ chars, uppercase, lowercase, number, special char), hashes with BCrypt, updates user.passwordHash, marks token as used, deletes all refresh tokens for user, logs to audit_logs, sends confirmation email. Returns 400 if token invalid or password weak.</description>
    </interface>

    <!-- Service Layer Interfaces -->
    <interface>
      <name>PasswordResetService.initiatePasswordReset</name>
      <kind>service method</kind>
      <signature>void initiatePasswordReset(String email, String ipAddress)</signature>
      <path>backend/src/main/java/com/ultrabms/service/PasswordResetService.java (NEW FILE)</path>
      <description>Business logic for password reset request. Checks rate limiting, finds user by email, invalidates previous tokens, generates secure token, saves to database, sends email asynchronously, logs to audit. Throws RateLimitExceededException if too many attempts.</description>
    </interface>

    <interface>
      <name>PasswordResetService.validateResetToken</name>
      <kind>service method</kind>
      <signature>TokenValidationResult validateResetToken(String token)</signature>
      <path>backend/src/main/java/com/ultrabms/service/PasswordResetService.java (NEW FILE)</path>
      <description>Validates token existence, expiration, usage status, and associated user. Returns TokenValidationResult with valid boolean, remaining minutes, and error message if invalid.</description>
    </interface>

    <interface>
      <name>PasswordResetService.resetPassword</name>
      <kind>service method</kind>
      <signature>void resetPassword(String token, String newPassword)</signature>
      <path>backend/src/main/java/com/ultrabms/service/PasswordResetService.java (NEW FILE)</path>
      <description>Business logic for completing password reset. Re-validates token, validates password strength, hashes password, updates user, marks token used, deletes refresh tokens, logs to audit, sends confirmation email. Throws InvalidTokenException or ValidationException.</description>
    </interface>

    <interface>
      <name>EmailService.sendPasswordResetEmail</name>
      <kind>service method</kind>
      <signature>@Async void sendPasswordResetEmail(User user, String resetToken)</signature>
      <path>backend/src/main/java/com/ultrabms/service/EmailService.java (NEW FILE)</path>
      <description>Sends password reset email asynchronously. Generates reset link with token, renders Thymeleaf template with branding, sends HTML + plain text email via Spring Mail + Gmail SMTP. Logs success/failure, fails silently (don't throw exception).</description>
    </interface>

    <interface>
      <name>EmailService.sendPasswordChangeConfirmation</name>
      <kind>service method</kind>
      <signature>@Async void sendPasswordChangeConfirmation(User user)</signature>
      <path>backend/src/main/java/com/ultrabms/service/EmailService.java (NEW FILE)</path>
      <description>Sends password change confirmation email asynchronously after successful reset. Includes security alert message, login link, timestamp. Rendered with Thymeleaf template.</description>
    </interface>

    <interface>
      <name>PasswordValidator.validate</name>
      <kind>utility method</kind>
      <signature>ValidationResult validate(String password)</signature>
      <path>backend/src/main/java/com/ultrabms/util/PasswordValidator.java (NEW FILE)</path>
      <description>Validates password strength. Checks: min 8 chars, uppercase, lowercase, digit, special char. Returns ValidationResult record with boolean isValid and List&lt;String&gt; errors. Use regex pattern matching for validation.</description>
    </interface>

    <!-- JPA Repository Interfaces -->
    <interface>
      <name>PasswordResetTokenRepository</name>
      <kind>repository</kind>
      <signature>interface PasswordResetTokenRepository extends JpaRepository&lt;PasswordResetToken, Long&gt;</signature>
      <path>backend/src/main/java/com/ultrabms/repository/PasswordResetTokenRepository.java (NEW FILE)</path>
      <description>Custom query methods: Optional&lt;PasswordResetToken&gt; findByToken(String token), void deleteByExpiresAtBefore(LocalDateTime dateTime), List&lt;PasswordResetToken&gt; findByUserIdAndUsedFalse(Long userId)</description>
    </interface>

    <interface>
      <name>PasswordResetAttemptRepository</name>
      <kind>repository</kind>
      <signature>interface PasswordResetAttemptRepository extends JpaRepository&lt;PasswordResetAttempt, Long&gt;</signature>
      <path>backend/src/main/java/com/ultrabms/repository/PasswordResetAttemptRepository.java (NEW FILE)</path>
      <description>Rate limiting persistence. Custom query methods: Optional&lt;PasswordResetAttempt&gt; findByEmail(String email), void deleteByFirstAttemptAtBefore(LocalDateTime dateTime)</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Spring Boot Test framework for integration tests with @SpringBootTest and MockMvc. JUnit 5 for unit tests with Mockito for mocking. Test RESTful endpoints with @WebMvcTest for controller layer testing. Use @DataJpaTest for repository layer testing with H2 in-memory database. Playwright for end-to-end frontend testing. Mock JavaMailSender for email tests to avoid sending real emails. Follow AAA pattern: Arrange, Act, Assert. Test location: backend/src/test/java/com/ultrabms/ mirroring main source structure.
    </standards>

    <locations>
      <location>backend/src/test/java/com/ultrabms/controller/AuthControllerTest.java</location>
      <location>backend/src/test/java/com/ultrabms/service/PasswordResetServiceTest.java</location>
      <location>backend/src/test/java/com/ultrabms/service/EmailServiceTest.java</location>
      <location>backend/src/test/java/com/ultrabms/util/PasswordValidatorTest.java</location>
      <location>backend/src/test/java/com/ultrabms/repository/PasswordResetTokenRepositoryTest.java</location>
      <location>frontend/tests/e2e/password-reset.spec.ts</location>
    </locations>

    <ideas>
      <!-- Unit Test Ideas -->
      <test id="unit-1" acs="12">
        <description>PasswordValidator unit tests: Test valid password (meets all requirements), test missing uppercase (should fail), test missing lowercase (should fail), test missing digit (should fail), test missing special char (should fail), test too short (&lt;8 chars, should fail), test edge cases (exactly 8 chars, all requirements)</description>
      </test>
      <test id="unit-2" acs="9">
        <description>Token generation unit test: Verify SecureRandom generates unique tokens (generate 1000 tokens, check no duplicates), verify tokens are 64 characters hex-encoded, verify cryptographic strength (32 bytes = 256 bits entropy)</description>
      </test>
      <test id="unit-3" acs="5,6">
        <description>EmailService unit tests: Mock JavaMailSender, verify sendPasswordResetEmail called with correct parameters, verify Thymeleaf template rendered with correct variables (resetLink, firstName, expirationMinutes), verify HTML and plain text emails sent, verify email failure logged but doesn't throw exception</description>
      </test>

      <!-- Integration Test Ideas -->
      <test id="integration-1" acs="1,7,9">
        <description>POST /api/v1/auth/forgot-password integration test: Test with valid registered email (should create token in DB, send email, return 200 OK), test with non-existent email (should return 200 OK without creating token - security), test invalid email format (should return 400 Bad Request), test rate limiting (3 requests OK, 4th returns 429), verify audit_logs entry created with PASSWORD_RESET_REQUESTED action</description>
      </test>
      <test id="integration-2" acs="2">
        <description>GET /api/v1/auth/reset-password/validate integration test: Test with valid non-expired token (should return 200 OK with valid=true, remainingMinutes), test with expired token (should return 400 Bad Request with INVALID_TOKEN), test with used token (should return 400), test with non-existent token (should return 400), verify remaining time calculation accurate</description>
      </test>
      <test id="integration-3" acs="3,9,12">
        <description>POST /api/v1/auth/reset-password integration test: Test happy path (valid token + strong password, should update user.passwordHash, mark token used, delete refresh tokens, return 200 OK), test with weak password (should return 400 with validation errors), test with expired token (should return 400), test with used token (should return 400), verify BCrypt hash updated in DB, verify refresh_tokens deleted for user, verify audit_logs entry with PASSWORD_RESET_COMPLETED, verify confirmation email sent</description>
      </test>
      <test id="integration-4" acs="8">
        <description>PasswordResetCleanupService scheduled job test: Create expired tokens (expiresAt in past) and old used tokens (used=true, createdAt &gt; 24 hours ago), manually trigger @Scheduled cleanup method, verify expired tokens deleted from DB, verify fresh tokens remain, verify cleanup stats logged at INFO level</description>
      </test>
      <test id="integration-5" acs="9">
        <description>Token invalidation test: Request password reset for user (token1 created), request again for same user (token2 created), verify token1 marked as used=true in DB (invalidated), verify only token2 is valid, attempt to use token1 should return 400 INVALID_TOKEN</description>
      </test>

      <!-- End-to-End Test Ideas -->
      <test id="e2e-1" acs="10,11,12">
        <description>Playwright E2E happy path: Navigate to /forgot-password, enter registered email, click "Send Reset Link", verify success toast displayed, check email inbox (use test email with API), extract reset link from email, navigate to /reset-password?token=XXX, verify countdown timer showing, enter strong password, verify password strength meter turns green, click "Reset Password", verify success message, verify redirect to /login after 3 seconds, login with new password, verify login successful</description>
      </test>
      <test id="e2e-2" acs="2,11">
        <description>Playwright E2E token expiration: Request password reset, wait 16 minutes (or mock expiresAt to past), click reset link, verify error message "Reset link is invalid or has expired", verify "Request new link" button shown, click button, verify redirected to /forgot-password</description>
      </test>
      <test id="e2e-3" acs="7">
        <description>Playwright E2E rate limiting: On /forgot-password page, submit same email 3 times rapidly, verify success message each time, submit 4th time, verify 429 error displayed "Too many password reset attempts. Please try again in X minutes", wait for rate limit to expire, retry, verify success</description>
      </test>
      <test id="e2e-4" acs="12">
        <description>Playwright E2E password validation: On /reset-password page with valid token, test password strength meter: Enter short password (7 chars) - verify "8+ characters" unchecked and red, enter password without uppercase - verify "Uppercase letter" unchecked, enter password without number - verify "Number" unchecked, enter password without special char - verify "Special character" unchecked, enter strong password - verify all checkmarks green and strength bar green, submit - verify success</description>
      </test>
    </ideas>
  </tests>
</story-context>
