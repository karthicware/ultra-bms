<?xml version="1.0" encoding="UTF-8"?>
<story-context xmlns="urn:bmad:story-context:v1"
               story-key="1-6-aws-s3-file-storage-integration"
               epic-id="1"
               story-id="6"
               generated-date="2025-11-22">

  <!-- ===================================================================== -->
  <!-- STORY SUMMARY                                                          -->
  <!-- ===================================================================== -->
  <story-summary>
    <title>AWS S3 File Storage Integration</title>
    <user-story>
      <as-a>backend developer</as-a>
      <i-want>file storage to use AWS S3 instead of the local filesystem</i-want>
      <so-that>document uploads are scalable, reliable, and accessible across all application modules</so-that>
    </user-story>
    <status>drafted</status>
    <source-file>docs/sprint-artifacts/1-6-aws-s3-file-storage-integration.md</source-file>
  </story-summary>

  <!-- ===================================================================== -->
  <!-- PROJECT DOCUMENTATION CONTEXT                                          -->
  <!-- ===================================================================== -->
  <project-documentation>

    <!-- PRD: Product Requirements Document -->
    <document type="prd" path="docs/prd.md">
      <relevant-sections>
        <section name="5.4 Document Management" lines="377-396">
          <summary>
            Requirements for document storage across all modules (Leads, Properties, Tenants,
            Maintenance, Vendors, Financial, Compliance). Defines document types, upload workflows,
            and security requirements.
          </summary>
          <key-points>
            <point>Central document repository for all modules</point>
            <point>Support for PDF, JPG, PNG file types</point>
            <point>File size limits: 5MB standard, 10MB for special cases</point>
            <point>Secure access with presigned URLs</point>
            <point>Multi-module support: Emirates ID, passports, contracts, invoices, photos, etc.</point>
          </key-points>
        </section>

        <section name="3.2.1 Lead Document Upload" lines="171-186">
          <summary>
            Lead-specific document upload requirements: Emirates ID, passport, visa, contract uploads
            with drag-drop support and type validation.
          </summary>
        </section>

        <section name="3.3.7 Property Image Management" lines="246-260">
          <summary>
            Property image upload requirements: multiple images (max 5 per property), drag-drop,
            reordering, primary image selection.
          </summary>
        </section>
      </relevant-sections>
    </document>

    <!-- Architecture: Technical Architecture Document -->
    <document type="architecture" path="docs/architecture.md">
      <relevant-sections>
        <section name="2.2 Backend Architecture - File Storage" lines="134-162">
          <summary>
            File storage architecture defining AWS S3 integration for all document types. Specifies
            S3 bucket structure, LocalStack for development, and presigned URL patterns.
          </summary>
          <key-points>
            <point>AWS S3 bucket: ultrabms-{environment}-storage (UAE region me-central-1)</point>
            <point>LocalStack (http://localhost:4566) for local development</point>
            <point>S3 key pattern: {module}/{entityId}/documents/{uuid}.{extension}</point>
            <point>Presigned URLs with 5-minute expiration for downloads</point>
            <point>FileStorageService abstraction for file operations</point>
            <point>S3Service for direct S3 interactions</point>
          </key-points>
        </section>

        <section name="7.2.1 File Upload Flow" lines="876-912">
          <summary>
            Complete file upload flow from frontend to S3: multipart upload, validation (type, size),
            S3 storage, database record creation, and response with download URL.
          </summary>
          <sequence>
            <step>1. Frontend: User uploads file via drag-drop or file picker</step>
            <step>2. Frontend: Validate file type (PDF/JPG/PNG) and size (max 5MB)</step>
            <step>3. Frontend: Send multipart/form-data to backend API</step>
            <step>4. Backend: Receive MultipartFile in controller</step>
            <step>5. Backend: Validate file type and size (server-side)</step>
            <step>6. Backend: Upload to S3 using S3Service</step>
            <step>7. Backend: Store S3 key in database (file_path column)</step>
            <step>8. Backend: Generate presigned URL for download</step>
            <step>9. Backend: Return file metadata + presigned URL to frontend</step>
          </sequence>
        </section>

        <section name="2.2.6 Development Tools - LocalStack" lines="220-235">
          <summary>
            LocalStack setup for local S3 development without AWS credentials. Runs on localhost:4566
            with docker-compose integration.
          </summary>
          <configuration>
            <docker-image>localstack/localstack:3.0</docker-image>
            <endpoint>http://localhost:4566</endpoint>
            <services>s3</services>
            <auto-create-bucket>true</auto-create-bucket>
          </configuration>
        </section>
      </relevant-sections>
    </document>

    <!-- UX Design: User Experience Specification -->
    <document type="ux-design" path="docs/development/ux-design-specification.md">
      <relevant-sections>
        <section name="6.1.4 File Upload Zone Component" lines="854-868">
          <summary>
            UX requirements for file upload component: drag-and-drop area, file list with progress
            indicators, validation feedback, and remove buttons.
          </summary>
          <ux-states>
            <state>Empty: Dashed border with upload icon and instruction text</state>
            <state>Hovering: Highlighted when user drags file over zone</state>
            <state>Uploading: Progress indicator for each file</state>
            <state>Complete: File list with names and remove buttons</state>
            <state>Error: Red border with error message (invalid type or size)</state>
          </ux-states>
        </section>
      </relevant-sections>
    </document>

    <!-- Epic 1: Platform Foundation & Infrastructure -->
    <document type="epic" path="docs/epics/epic-1-platform-foundation-infrastructure.md">
      <relevant-sections>
        <section name="Story 1.6: AWS S3 File Storage Integration" lines="337-410">
          <summary>
            Complete acceptance criteria for S3 integration including LocalStack setup, file operations,
            presigned URLs, multi-module support, and configuration requirements.
          </summary>
          <acceptance-criteria>
            <criterion id="AC-1">
              S3Client configured with AWS SDK 2.x, UAE region (me-central-1), bucket naming
              convention: ultrabms-{environment}-storage
            </criterion>
            <criterion id="AC-2">
              File upload with UUID-based keys: {module}/{entityId}/documents/{uuid}.{extension}
              Example: leads/449b9bd0-.../documents/38bae96a-...jpg
            </criterion>
            <criterion id="AC-3">
              Presigned URLs with 5-minute expiration, Content-Disposition header for filename handling
            </criterion>
            <criterion id="AC-4">
              File deletion: S3 objects deleted when database records removed, graceful handling if
              already deleted (idempotent), batch deletion support
            </criterion>
            <criterion id="AC-5">
              LocalStack integration: runs on localhost:4566, S3 client uses LocalStack endpoint in dev
              profile, no AWS credentials required for local dev, Docker Compose service definition
            </criterion>
            <criterion id="AC-6">
              Multi-module support: Leads (Emirates ID, passport, visa, contracts), Properties (photos,
              floor plans, compliance docs), Tenants (ID, contracts, receipts), Maintenance (work orders,
              photos, invoices), Vendors (licenses, insurance), Financial (invoices, receipts, statements),
              Compliance (certificates, permits)
            </criterion>
            <criterion id="AC-7">
              Configuration: application.yml with aws.s3.bucket-name, aws.s3.region, aws.s3.endpoint
              (LocalStack override). Dev profile uses LocalStack endpoint.
            </criterion>
          </acceptance-criteria>

          <technical-notes>
            <note>Use AWS SDK for Java 2.x (already in pom.xml: software.amazon.awssdk:s3 v2.20.26)</note>
            <note>Implement FileStorageService as interface with S3FileStorageServiceImpl</note>
            <note>Keep database file_path column storing S3 keys (VARCHAR 500 sufficient)</note>
            <note>Use presigned URLs instead of streaming bytes through backend (reduces server load)</note>
            <note>LocalStack Docker image: localstack/localstack:3.0</note>
            <note>Use @ConditionalOnProperty to switch between local filesystem and S3 if needed</note>
            <note>Test with all file types (PDF, JPG, PNG) across all modules</note>
          </technical-notes>
        </section>

        <section name="Story 1.5: Basic REST API Structure" lines="256-336">
          <summary>
            FileStorageException handling and API error response format for file upload failures.
          </summary>
        </section>

        <section name="Story 1.4: Core Domain Models" lines="184-255">
          <summary>
            Entity relationships: LeadDocument, PropertyImage, TenantDocument entities with filePath
            column storing S3 keys.
          </summary>
        </section>
      </relevant-sections>
    </document>

  </project-documentation>

  <!-- ===================================================================== -->
  <!-- EXISTING CODE ANALYSIS                                                 -->
  <!-- ===================================================================== -->
  <existing-code>

    <!-- S3 Service: Core S3 operations (ALREADY IMPLEMENTED) -->
    <file path="backend/src/main/java/com/ultrabms/service/S3Service.java"
          status="exists"
          action-required="verify-and-enhance">
      <summary>
        S3 service interface defining core S3 operations. ALREADY IMPLEMENTED with upload, delete,
        and presigned URL generation methods.
      </summary>
      <interface>
        <method>String uploadFile(MultipartFile file, String directory)</method>
        <method>void deleteFile(String filePath)</method>
        <method>String getPresignedUrl(String filePath)</method>
      </interface>
      <current-implementation>
        <detail>✅ Upload: Validates type/size (10MB max), generates UUID filename, uploads to S3</detail>
        <detail>✅ Delete: Deletes S3 object by key</detail>
        <detail>✅ Presigned URL: Generates 1-hour presigned GET URL</detail>
        <detail>❌ Presigned URL duration needs to be reduced from 1 hour to 5 minutes per AC</detail>
      </current-implementation>
      <action-items>
        <action>Change presigned URL duration from Duration.ofHours(1) to Duration.ofMinutes(5)</action>
        <action>Verify file size limit alignment (currently 10MB, AC says 5MB)</action>
        <action>Add batch deletion support for multiple files</action>
      </action-items>
    </file>

    <!-- S3 Service Implementation -->
    <file path="backend/src/main/java/com/ultrabms/service/impl/S3ServiceImpl.java"
          status="exists"
          action-required="enhance-and-refactor">
      <summary>
        S3 service implementation with AWS SDK 2.x integration. Currently validates files, uploads to
        S3, and generates presigned URLs. Needs LocalStack endpoint support and duration adjustments.
      </summary>
      <current-implementation>
        <validation>
          <allowed-types>image/jpeg, image/jpg, image/png, application/pdf</allowed-types>
          <max-size>10MB (needs alignment with AC: 5MB)</max-size>
          <filename-sanitization>UUID-based with original extension</filename-sanitization>
        </validation>
        <s3-operations>
          <upload>Uses PutObjectRequest with content-type, content-length metadata</upload>
          <delete>Uses DeleteObjectRequest</delete>
          <presigned-url>Creates S3Presigner, generates 1-hour URL (needs: 5 minutes)</presigned-url>
        </s3-operations>
      </current-implementation>
      <issues>
        <issue priority="high">
          Presigned URL duration is 1 hour, AC requires 5 minutes.
          Change: Duration.ofHours(1) → Duration.ofMinutes(5)
        </issue>
        <issue priority="medium">
          Max file size is 10MB, but AC and validation docs say 5MB standard. Align to 5MB.
        </issue>
        <issue priority="high">
          S3Presigner is created inline and closed after each call. Should be injected as bean for
          better resource management.
        </issue>
        <issue priority="medium">
          No batch deletion support. Add method: void deleteFiles(List&lt;String&gt; filePaths)
        </issue>
      </issues>
      <action-items>
        <action>Reduce presigned URL expiration to 5 minutes</action>
        <action>Change MAX_FILE_SIZE from 10MB to 5MB</action>
        <action>Inject S3Presigner as bean instead of creating inline</action>
        <action>Add batch deletion method</action>
        <action>Add Content-Disposition header to presigned URLs for proper filename handling</action>
      </action-items>
    </file>

    <!-- S3 Configuration -->
    <file path="backend/src/main/java/com/ultrabms/config/S3Config.java"
          status="exists"
          action-required="add-localstack-support">
      <summary>
        S3 configuration class creating S3Client bean. Uses DefaultCredentialsProvider and hardcoded
        region (me-central-1). NEEDS LocalStack endpoint override support for dev profile.
      </summary>
      <current-implementation>
        <property name="region" value="me-central-1" source="@Value"/>
        <bean name="s3Client">
          <builder>S3Client.builder()</builder>
          <region>Region.of(region)</region>
          <credentials>DefaultCredentialsProvider.create()</credentials>
        </bean>
      </current-implementation>
      <missing-features>
        <feature>LocalStack endpoint override for dev profile</feature>
        <feature>S3Presigner bean for presigned URL generation</feature>
        <feature>Bucket name configuration injection</feature>
      </missing-features>
      <action-items>
        <action>Add @Value("${aws.s3.endpoint:}") String endpoint property</action>
        <action>Conditionally set endpoint override if endpoint property is not empty</action>
        <action>Add S3Presigner bean with same region and endpoint configuration</action>
        <action>Add bucket name validation on startup</action>
      </action-items>
      <code-pattern>
        <example>
          // Add endpoint override for LocalStack
          S3Client.Builder builder = S3Client.builder()
              .region(Region.of(region))
              .credentialsProvider(DefaultCredentialsProvider.create());

          if (endpoint != null &amp;&amp; !endpoint.isEmpty()) {
              builder.endpointOverride(URI.create(endpoint));
          }

          return builder.build();
        </example>
      </code-pattern>
    </file>

    <!-- File Storage Service Interface -->
    <file path="backend/src/main/java/com/ultrabms/service/FileStorageService.java"
          status="exists"
          action-required="add-presigned-url-method">
      <summary>
        File storage service interface defining abstraction for file operations. Currently has local
        filesystem methods (storeFile, deleteFile, getAbsolutePath, loadFile). NEEDS presigned URL
        method for S3 download support.
      </summary>
      <current-interface>
        <method>String storeFile(MultipartFile file, String directory)</method>
        <method>void deleteFile(String filePath)</method>
        <method>String getAbsolutePath(String filePath)</method>
        <method>byte[] loadFile(String filePath)</method>
      </current-interface>
      <action-items>
        <action>Add method: String getDownloadUrl(String filePath)</action>
        <action>Deprecate loadFile() - should use presigned URLs instead of streaming bytes</action>
        <action>Deprecate getAbsolutePath() - not applicable for S3 storage</action>
        <action>Keep storeFile() and deleteFile() - compatible with S3</action>
      </action-items>
      <refactored-interface>
        <method>String storeFile(MultipartFile file, String directory)</method>
        <method>void deleteFile(String filePath)</method>
        <method>String getDownloadUrl(String filePath) // NEW: Returns presigned URL</method>
        <method deprecated="true">byte[] loadFile(String filePath) // Deprecated: Use presigned URLs</method>
        <method deprecated="true">String getAbsolutePath(String filePath) // Deprecated: N/A for S3</method>
      </refactored-interface>
    </file>

    <!-- File Storage Service Implementation (Local Filesystem) -->
    <file path="backend/src/main/java/com/ultrabms/service/impl/FileStorageServiceImpl.java"
          status="exists"
          action-required="refactor-to-use-s3">
      <summary>
        Current implementation saves files to local filesystem (backend/uploads/). NEEDS complete
        refactoring to delegate all operations to S3Service instead of local filesystem.
      </summary>
      <current-implementation>
        <storage-location>backend/uploads/ (local filesystem)</storage-location>
        <validation>
          <allowed-types>image/jpeg, image/jpg, image/png, application/pdf</allowed-types>
          <max-size>5MB</max-size>
        </validation>
        <operations>
          <storeFile>Creates local directories, copies file to filesystem</storeFile>
          <deleteFile>Deletes file from filesystem</deleteFile>
          <getAbsolutePath>Returns absolute path in filesystem</getAbsolutePath>
          <loadFile>Reads file as byte array from filesystem</loadFile>
        </operations>
      </current-implementation>
      <refactoring-strategy>
        <approach>Delegate to S3Service instead of filesystem operations</approach>
        <steps>
          <step>1. Inject S3Service dependency</step>
          <step>2. Replace Files.copy() with s3Service.uploadFile()</step>
          <step>3. Replace Files.delete() with s3Service.deleteFile()</step>
          <step>4. Implement getDownloadUrl() by calling s3Service.getPresignedUrl()</step>
          <step>5. Deprecate/remove loadFile() and getAbsolutePath()</step>
          <step>6. Remove @Value("${file.upload-dir:uploads}") property</step>
          <step>7. Keep same validation logic (type, size)</step>
        </steps>
      </refactoring-strategy>
      <action-items>
        <action priority="critical">
          Refactor storeFile() to use s3Service.uploadFile() instead of filesystem
        </action>
        <action priority="critical">
          Refactor deleteFile() to use s3Service.deleteFile() instead of filesystem
        </action>
        <action priority="high">
          Implement getDownloadUrl() to return presigned URL from s3Service
        </action>
        <action priority="medium">
          Mark loadFile() as deprecated (use presigned URLs for downloads)
        </action>
        <action priority="low">
          Mark getAbsolutePath() as deprecated (not applicable for S3)
        </action>
      </action-items>
    </file>

    <!-- Lead Service Implementation (Consumer of FileStorageService) -->
    <file path="backend/src/main/java/com/ultrabms/service/impl/LeadServiceImpl.java"
          status="exists"
          action-required="update-download-logic">
      <summary>
        Lead service uses FileStorageService for document uploads. Currently calls
        fileStorageService.storeFile() for uploads and fileStorageService.loadFile() for downloads.
        NEEDS update to use presigned URLs instead of loadFile().
      </summary>
      <current-usage>
        <upload-flow>
          <code-snippet line="approx-580">
            String filePath = fileStorageService.storeFile(
                file,
                String.format("leads/%s/documents", leadId)
            );
          </code-snippet>
        </upload-flow>
        <download-flow>
          <code-snippet line="approx-620">
            return fileStorageService.loadFile(document.getFilePath());
          </code-snippet>
          <issue>
            Currently loads file as byte array and streams through backend. Should use presigned URLs
            for direct S3 download instead.
          </issue>
        </download-flow>
      </current-usage>
      <action-items>
        <action>
          Update download methods to return presigned URLs instead of byte arrays:
          Replace: byte[] loadFile() → String getDownloadUrl()
        </action>
        <action>
          Update LeadDocumentResponse to include downloadUrl field with presigned URL
        </action>
        <action>
          No changes needed for upload flow - storeFile() will work with S3 after refactoring
        </action>
      </action-items>
    </file>

    <!-- Property Service Implementation (Consumer of FileStorageService) -->
    <file path="backend/src/main/java/com/ultrabms/service/impl/PropertyServiceImpl.java"
          status="exists"
          action-required="update-download-logic">
      <summary>
        Property service uses FileStorageService for image uploads. Currently calls
        fileStorageService.storeFile() for uploads and fileStorageService.deleteFile() for deletions.
        NEEDS presigned URL support for image downloads.
      </summary>
      <current-usage>
        <upload-flow>
          <code-snippet line="approx-350">
            String filePath = fileStorageService.storeFile(
                file,
                String.format("properties/%s/images", propertyId)
            );
          </code-snippet>
        </upload-flow>
        <delete-flow>
          <code-snippet line="approx-430">
            fileStorageService.deleteFile(image.getFilePath());
            propertyImageRepository.delete(image);
          </code-snippet>
        </delete-flow>
      </current-usage>
      <action-items>
        <action>
          Update PropertyImageResponse to include downloadUrl field with presigned URL
        </action>
        <action>
          Add getDownloadUrl() call when returning property images
        </action>
        <action>
          No changes needed for upload/delete flows - will work with S3 after refactoring
        </action>
      </action-items>
    </file>

    <!-- File Storage Exception -->
    <file path="backend/src/main/java/com/ultrabms/exception/FileStorageException.java"
          status="exists"
          action-required="verify-usage">
      <summary>
        Custom exception for file storage errors. Used for validation failures, upload errors, and
        deletion failures. Ensure S3-specific errors are properly wrapped.
      </summary>
      <action-items>
        <action>Verify all S3Exception are caught and wrapped in FileStorageException</action>
        <action>Add specific error messages for S3 errors (bucket not found, access denied, etc.)</action>
      </action-items>
    </file>

  </existing-code>

  <!-- ===================================================================== -->
  <!-- CONFIGURATION FILES                                                    -->
  <!-- ===================================================================== -->
  <configuration-files>

    <!-- Docker Compose: LocalStack Setup -->
    <file path="docker-compose.yml" status="needs-localstack-service">
      <summary>
        Currently has PostgreSQL service only. NEEDS LocalStack service definition for local S3
        development.
      </summary>
      <action-items>
        <action>Add LocalStack service with S3 support</action>
        <action>Configure auto-creation of ultrabms-dev-storage bucket</action>
        <action>Map port 4566 for S3 endpoint</action>
        <action>Add health check for LocalStack readiness</action>
      </action-items>
      <localstack-service-template>
        <yaml-definition>
          <![CDATA[
  localstack:
    image: localstack/localstack:3.0
    container_name: ultra-bms-localstack
    environment:
      SERVICES: s3
      DEBUG: 0
      DATA_DIR: /tmp/localstack/data
      PERSISTENCE: 1
      AWS_DEFAULT_REGION: me-central-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/tmp/localstack
      - ./localstack-init.sh:/etc/localstack/init/ready.d/init-s3.sh
    networks:
      - ultra-bms-network
    healthcheck:
      test: ["CMD", "awslocal", "s3", "ls", "s3://ultrabms-dev-storage"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  localstack_data:
          ]]>
        </yaml-definition>
        <init-script path="localstack-init.sh">
          <![CDATA[
#!/bin/bash
echo "Creating S3 bucket for Ultra BMS..."
awslocal s3 mb s3://ultrabms-dev-storage --region me-central-1
echo "S3 bucket created successfully"
          ]]>
        </init-script>
      </localstack-service-template>
    </file>

    <!-- Application Configuration (Dev Profile) -->
    <file path="backend/src/main/resources/application-dev.yml" status="needs-s3-config">
      <summary>
        Current dev config has database, cache, mail, and JWT settings. NEEDS AWS S3 configuration
        with LocalStack endpoint override.
      </summary>
      <missing-configuration>
        <section>aws.s3</section>
        <properties>
          <property>bucket-name: ultrabms-dev-storage</property>
          <property>region: me-central-1</property>
          <property>endpoint: http://localhost:4566 (LocalStack)</property>
        </properties>
      </missing-configuration>
      <action-items>
        <action>Add aws.s3 section to application-dev.yml</action>
        <action>Set endpoint to LocalStack URL for dev profile</action>
        <action>Document that LocalStack must be running before backend starts</action>
      </action-items>
      <s3-config-template>
        <yaml-definition>
          <![CDATA[
# AWS S3 Configuration (LocalStack for Dev)
aws:
  s3:
    bucket-name: ultrabms-dev-storage
    region: me-central-1
    endpoint: http://localhost:4566  # LocalStack endpoint
    # For production, remove endpoint property to use real AWS S3
          ]]>
        </yaml-definition>
      </s3-config-template>
    </file>

    <!-- Application Configuration (Production Profile) -->
    <file path="backend/src/main/resources/application-prod.yml" status="needs-s3-config">
      <summary>
        Production configuration file. NEEDS AWS S3 configuration for real S3 (no endpoint override).
      </summary>
      <s3-config-template>
        <yaml-definition>
          <![CDATA[
# AWS S3 Configuration (Real AWS S3)
aws:
  s3:
    bucket-name: ${S3_BUCKET_NAME:ultrabms-prod-storage}
    region: ${AWS_REGION:me-central-1}
    # No endpoint property - uses real AWS S3
          ]]>
        </yaml-definition>
      </s3-config-template>
    </file>

    <!-- Maven POM -->
    <file path="backend/pom.xml" status="dependencies-already-exist">
      <summary>
        AWS SDK for S3 already added (software.amazon.awssdk:s3 version 2.20.26). No changes needed.
      </summary>
      <existing-dependencies>
        <dependency>
          <groupId>software.amazon.awssdk</groupId>
          <artifactId>s3</artifactId>
          <version>2.20.26</version>
        </dependency>
      </existing-dependencies>
      <action-items>
        <action>Verify AWS SDK version is compatible with LocalStack 3.0</action>
        <action>Consider updating to latest 2.x version if needed</action>
      </action-items>
    </file>

  </configuration-files>

  <!-- ===================================================================== -->
  <!-- MODULE-SPECIFIC FILE PATTERNS                                          -->
  <!-- ===================================================================== -->
  <module-file-patterns>
    <module name="leads">
      <s3-directory>leads/{leadId}/documents</s3-directory>
      <document-types>
        <type>EMIRATES_ID</type>
        <type>PASSPORT</type>
        <type>VISA</type>
        <type>CONTRACT</type>
      </document-types>
      <entity>LeadDocument</entity>
      <service>LeadServiceImpl</service>
      <repository>LeadDocumentRepository</repository>
    </module>

    <module name="properties">
      <s3-directory>properties/{propertyId}/images</s3-directory>
      <document-types>
        <type>PROPERTY_IMAGE</type>
        <type>FLOOR_PLAN</type>
        <type>TITLE_DEED</type>
        <type>COMPLIANCE_DOC</type>
      </document-types>
      <entity>PropertyImage</entity>
      <service>PropertyServiceImpl</service>
      <repository>PropertyImageRepository</repository>
    </module>

    <module name="tenants">
      <s3-directory>tenants/{tenantId}/documents</s3-directory>
      <document-types>
        <type>ID_COPY</type>
        <type>LEASE_CONTRACT</type>
        <type>PAYMENT_RECEIPT</type>
        <type>PASSPORT</type>
      </document-types>
      <entity>TenantDocument</entity>
      <service>TenantServiceImpl</service>
      <repository>TenantDocumentRepository</repository>
    </module>

    <module name="maintenance">
      <s3-directory>maintenance/{requestId}/attachments</s3-directory>
      <document-types>
        <type>WORK_ORDER_PHOTO</type>
        <type>INVOICE</type>
        <type>COMPLETION_REPORT</type>
      </document-types>
      <entity>MaintenanceRequest (has attachments field)</entity>
      <service>MaintenanceRequestServiceImpl</service>
      <note>Maintenance uses embedded attachments list, not separate entity</note>
    </module>

    <module name="vendors">
      <s3-directory>vendors/{vendorId}/documents</s3-directory>
      <document-types>
        <type>LICENSE</type>
        <type>INSURANCE</type>
        <type>CONTRACT</type>
        <type>TRADE_LICENSE</type>
      </document-types>
      <entity>VendorDocument (future)</entity>
      <note>Vendor document management not yet implemented</note>
    </module>

    <module name="financial">
      <s3-directory>financial/{transactionId}/documents</s3-directory>
      <document-types>
        <type>INVOICE</type>
        <type>RECEIPT</type>
        <type>BANK_STATEMENT</type>
        <type>AUDIT_REPORT</type>
      </document-types>
      <entity>FinancialDocument (future)</entity>
      <note>Financial document management not yet implemented</note>
    </module>

    <module name="compliance">
      <s3-directory>compliance/{complianceId}/documents</s3-directory>
      <document-types>
        <type>CERTIFICATE</type>
        <type>INSPECTION_REPORT</type>
        <type>PERMIT</type>
        <type>APPROVAL</type>
      </document-types>
      <entity>ComplianceDocument (future)</entity>
      <note>Compliance document management not yet implemented</note>
    </module>
  </module-file-patterns>

  <!-- ===================================================================== -->
  <!-- TESTING REQUIREMENTS                                                   -->
  <!-- ===================================================================== -->
  <testing-requirements>
    <unit-tests>
      <test-class>S3ServiceImplTest</test-class>
      <test-cases>
        <test>testUploadFile_Success</test>
        <test>testUploadFile_InvalidType_ThrowsException</test>
        <test>testUploadFile_ExceedsMaxSize_ThrowsException</test>
        <test>testUploadFile_EmptyFile_ThrowsException</test>
        <test>testDeleteFile_Success</test>
        <test>testDeleteFile_NotFound_HandlesGracefully</test>
        <test>testGetPresignedUrl_Success</test>
        <test>testGetPresignedUrl_ExpiresAfter5Minutes</test>
        <test>testBatchDelete_Success</test>
      </test-cases>
    </unit-tests>

    <integration-tests>
      <test-class>FileStorageServiceIntegrationTest</test-class>
      <test-cases>
        <test>testStoreFile_UploadsToS3</test>
        <test>testDeleteFile_RemovesFromS3</test>
        <test>testGetDownloadUrl_ReturnsValidPresignedUrl</test>
        <test>testUploadAndDownload_LeadDocument</test>
        <test>testUploadAndDownload_PropertyImage</test>
      </test-cases>
      <prerequisites>
        <prerequisite>LocalStack running on localhost:4566</prerequisite>
        <prerequisite>Test bucket created: ultrabms-test-storage</prerequisite>
      </prerequisites>
    </integration-tests>

    <e2e-tests>
      <test-scenario>Lead Document Upload Flow</test-scenario>
      <steps>
        <step>1. Start LocalStack via docker-compose</step>
        <step>2. Start backend server with dev profile</step>
        <step>3. POST /api/v1/leads/{leadId}/documents with PDF file</step>
        <step>4. Verify response contains documentId and downloadUrl</step>
        <step>5. GET downloadUrl (presigned URL) and verify file downloads correctly</step>
        <step>6. DELETE /api/v1/leads/{leadId}/documents/{documentId}</step>
        <step>7. Verify file deleted from S3</step>
      </steps>
    </e2e-tests>

    <localstack-validation>
      <test>Verify bucket creation on startup</test>
      <test>Verify S3 client connects to localhost:4566</test>
      <test>Verify files are stored with correct S3 keys</test>
      <test>Verify presigned URLs use LocalStack endpoint</test>
      <test>Verify deletion removes objects from LocalStack</test>
    </localstack-validation>
  </testing-requirements>

  <!-- ===================================================================== -->
  <!-- DEVELOPMENT CONSTRAINTS                                                -->
  <!-- ===================================================================== -->
  <development-constraints>
    <constraint type="backward-compatibility">
      FileStorageService interface changes must not break existing consumers (LeadServiceImpl,
      PropertyServiceImpl). Add new methods (getDownloadUrl) but keep existing methods temporarily
      as deprecated.
    </constraint>

    <constraint type="data-migration">
      No data migration needed - this is greenfield S3 integration. Existing local filesystem files
      (if any) should remain for historical reference but new uploads go to S3.
    </constraint>

    <constraint type="environment-parity">
      Dev environment uses LocalStack (localhost:4566), staging/prod use real AWS S3 (me-central-1).
      Configuration must support both seamlessly via endpoint override property.
    </constraint>

    <constraint type="security">
      Never commit AWS credentials to git. Production credentials must use IAM roles or environment
      variables only. Dev environment uses LocalStack with dummy credentials (test/test).
    </constraint>

    <constraint type="performance">
      Use presigned URLs for downloads instead of streaming bytes through backend. This reduces server
      load and enables direct S3 downloads from frontend.
    </constraint>

    <constraint type="file-size">
      Standard max size is 5MB. Special cases (lease agreements) can be 10MB but require explicit
      validation override. Align S3ServiceImpl max size to 5MB.
    </constraint>

    <constraint type="allowed-types">
      Only PDF, JPG, PNG files allowed. Validation must occur both frontend (UX) and backend (security).
      Check both file extension and MIME type (not just extension - prevent bypass).
    </constraint>

    <constraint type="idempotency">
      File deletion must be idempotent - if S3 object already deleted, operation should succeed without
      error (graceful handling). This prevents errors during cleanup operations.
    </constraint>
  </development-constraints>

  <!-- ===================================================================== -->
  <!-- IMPLEMENTATION STEPS                                                   -->
  <!-- ===================================================================== -->
  <implementation-steps>

    <step number="1" priority="critical">
      <title>Add LocalStack to docker-compose.yml</title>
      <description>
        Add LocalStack service with S3 support, auto-bucket creation, and health check
      </description>
      <files-to-change>
        <file>docker-compose.yml</file>
        <file>localstack-init.sh (create new)</file>
      </files-to-change>
      <validation>
        <check>Run: docker-compose up localstack</check>
        <check>Verify: awslocal s3 ls shows ultrabms-dev-storage bucket</check>
        <check>Verify: curl http://localhost:4566/_localstack/health shows S3 running</check>
      </validation>
    </step>

    <step number="2" priority="critical">
      <title>Add S3 configuration to application-dev.yml</title>
      <description>
        Add aws.s3 section with LocalStack endpoint override for dev profile
      </description>
      <files-to-change>
        <file>backend/src/main/resources/application-dev.yml</file>
      </files-to-change>
      <configuration>
        <property>aws.s3.bucket-name: ultrabms-dev-storage</property>
        <property>aws.s3.region: me-central-1</property>
        <property>aws.s3.endpoint: http://localhost:4566</property>
      </configuration>
      <validation>
        <check>Verify properties load correctly on app startup</check>
        <check>Verify @Value annotations bind to correct values</check>
      </validation>
    </step>

    <step number="3" priority="critical">
      <title>Update S3Config to support LocalStack endpoint</title>
      <description>
        Add endpoint override capability to S3Client and create S3Presigner bean
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/config/S3Config.java</file>
      </files-to-change>
      <code-changes>
        <change>Add @Value("${aws.s3.endpoint:}") String endpoint property</change>
        <change>Conditionally set endpointOverride if endpoint is not empty</change>
        <change>Create S3Presigner bean with same region and endpoint config</change>
      </code-changes>
      <validation>
        <check>Start app with LocalStack running</check>
        <check>Verify S3Client connects to localhost:4566</check>
        <check>Check logs for successful S3 client initialization</check>
      </validation>
    </step>

    <step number="4" priority="high">
      <title>Fix S3ServiceImpl presigned URL duration and file size</title>
      <description>
        Change presigned URL expiration from 1 hour to 5 minutes and max file size from 10MB to 5MB
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/service/impl/S3ServiceImpl.java</file>
      </files-to-change>
      <code-changes>
        <change>Change: Duration.ofHours(1) → Duration.ofMinutes(5)</change>
        <change>Change: MAX_FILE_SIZE from 10 * 1024 * 1024 → 5 * 1024 * 1024</change>
        <change>Inject S3Presigner bean instead of creating inline</change>
      </code-changes>
      <validation>
        <check>Upload file and verify presigned URL expires after 5 minutes</check>
        <check>Try uploading 6MB file and verify rejection</check>
      </validation>
    </step>

    <step number="5" priority="high">
      <title>Add batch deletion support to S3Service</title>
      <description>
        Add deleteFiles() method for batch deletion (used during entity cleanup)
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/service/S3Service.java</file>
        <file>backend/src/main/java/com/ultrabms/service/impl/S3ServiceImpl.java</file>
      </files-to-change>
      <code-changes>
        <change>Add method to interface: void deleteFiles(List&lt;String&gt; filePaths)</change>
        <change>Implement using DeleteObjectsRequest for batch deletion</change>
        <change>Handle partial failures gracefully (log warnings but continue)</change>
      </code-changes>
      <validation>
        <check>Upload 5 files to S3</check>
        <check>Call deleteFiles() with all 5 file paths</check>
        <check>Verify all files deleted from S3</check>
      </validation>
    </step>

    <step number="6" priority="critical">
      <title>Add getDownloadUrl() method to FileStorageService interface</title>
      <description>
        Add presigned URL method to FileStorageService for download support
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/service/FileStorageService.java</file>
      </files-to-change>
      <code-changes>
        <change>Add method: String getDownloadUrl(String filePath)</change>
        <change>Mark loadFile() as @Deprecated with migration note</change>
        <change>Mark getAbsolutePath() as @Deprecated</change>
      </code-changes>
      <validation>
        <check>Verify interface compiles with new method</check>
        <check>Verify IDE shows deprecated methods with strikethrough</check>
      </validation>
    </step>

    <step number="7" priority="critical">
      <title>Refactor FileStorageServiceImpl to use S3Service</title>
      <description>
        Complete refactoring of FileStorageServiceImpl to delegate all operations to S3Service
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/service/impl/FileStorageServiceImpl.java</file>
      </files-to-change>
      <code-changes>
        <change>Inject S3Service dependency</change>
        <change>Replace Files.copy() with s3Service.uploadFile() in storeFile()</change>
        <change>Replace Files.delete() with s3Service.deleteFile() in deleteFile()</change>
        <change>Implement getDownloadUrl() using s3Service.getPresignedUrl()</change>
        <change>Remove @Value("${file.upload-dir:uploads}") uploadDir property</change>
        <change>Keep validation logic (type, size) before delegating to S3</change>
      </code-changes>
      <validation>
        <check>Unit test: Mock S3Service and verify delegation</check>
        <check>Integration test: Upload file and verify in S3</check>
        <check>Integration test: Delete file and verify removed from S3</check>
      </validation>
    </step>

    <step number="8" priority="medium">
      <title>Update LeadServiceImpl to use presigned URLs</title>
      <description>
        Update download methods to return presigned URLs instead of byte arrays
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/service/impl/LeadServiceImpl.java</file>
        <file>backend/src/main/java/com/ultrabms/dto/leads/LeadDocumentResponse.java</file>
      </files-to-change>
      <code-changes>
        <change>Replace fileStorageService.loadFile() with fileStorageService.getDownloadUrl()</change>
        <change>Add downloadUrl field to LeadDocumentResponse</change>
        <change>Populate downloadUrl when building response DTO</change>
      </code-changes>
      <validation>
        <check>GET /api/v1/leads/{id}/documents and verify downloadUrl in response</check>
        <check>Access downloadUrl and verify file downloads correctly</check>
      </validation>
    </step>

    <step number="9" priority="medium">
      <title>Update PropertyServiceImpl to use presigned URLs</title>
      <description>
        Add presigned URL support for property image downloads
      </description>
      <files-to-change>
        <file>backend/src/main/java/com/ultrabms/service/impl/PropertyServiceImpl.java</file>
        <file>backend/src/main/java/com/ultrabms/dto/properties/PropertyImageResponse.java</file>
      </files-to-change>
      <code-changes>
        <change>Add fileStorageService.getDownloadUrl() call when building PropertyImageResponse</change>
        <change>Add downloadUrl field to PropertyImageResponse</change>
      </code-changes>
      <validation>
        <check>GET /api/v1/properties/{id}/images and verify downloadUrl in response</check>
        <check>Access downloadUrl and verify image downloads correctly</check>
      </validation>
    </step>

    <step number="10" priority="low">
      <title>Update README with LocalStack setup instructions</title>
      <description>
        Document LocalStack setup, S3 configuration, and troubleshooting steps
      </description>
      <files-to-change>
        <file>backend/README.md</file>
      </files-to-change>
      <documentation-sections>
        <section>LocalStack Setup (docker-compose up localstack)</section>
        <section>S3 Bucket Verification (awslocal s3 ls)</section>
        <section>Troubleshooting (connection refused, bucket not found, etc.)</section>
        <section>Production Deployment (IAM roles, bucket policies)</section>
      </documentation-sections>
    </step>

    <step number="11" priority="medium">
      <title>Write integration tests for S3 file operations</title>
      <description>
        Comprehensive integration tests with LocalStack for upload, download, delete flows
      </description>
      <files-to-create>
        <file>backend/src/test/java/com/ultrabms/service/impl/S3ServiceImplTest.java</file>
        <file>backend/src/test/java/com/ultrabms/service/impl/FileStorageServiceIntegrationTest.java</file>
      </files-to-create>
      <test-coverage>
        <test>Upload PDF file to S3 via FileStorageService</test>
        <test>Upload JPG image to S3</test>
        <test>Upload PNG image to S3</test>
        <test>Reject invalid file type (e.g., .exe)</test>
        <test>Reject oversized file (> 5MB)</test>
        <test>Delete file from S3</test>
        <test>Batch delete multiple files</test>
        <test>Generate presigned URL and verify download</test>
        <test>Verify presigned URL expires after 5 minutes</test>
      </test-coverage>
    </step>

    <step number="12" priority="low">
      <title>Add production S3 configuration to application-prod.yml</title>
      <description>
        Add S3 configuration for production profile (no endpoint override)
      </description>
      <files-to-change>
        <file>backend/src/main/resources/application-prod.yml</file>
      </files-to-change>
      <configuration>
        <property>aws.s3.bucket-name: ${S3_BUCKET_NAME:ultrabms-prod-storage}</property>
        <property>aws.s3.region: ${AWS_REGION:me-central-1}</property>
        <note>No endpoint property - uses real AWS S3</note>
      </configuration>
    </step>

  </implementation-steps>

  <!-- ===================================================================== -->
  <!-- VALIDATION CHECKLIST                                                   -->
  <!-- ===================================================================== -->
  <validation-checklist>
    <category name="LocalStack Setup">
      <check>✅ LocalStack service runs successfully via docker-compose</check>
      <check>✅ S3 bucket ultrabms-dev-storage created automatically</check>
      <check>✅ Health check passes for LocalStack S3 service</check>
      <check>✅ Backend connects to LocalStack on localhost:4566</check>
    </category>

    <category name="File Upload Operations">
      <check>✅ PDF file uploads to S3 with correct key pattern</check>
      <check>✅ JPG image uploads to S3 successfully</check>
      <check>✅ PNG image uploads to S3 successfully</check>
      <check>✅ File size validation rejects files > 5MB</check>
      <check>✅ File type validation rejects invalid types (e.g., .exe, .zip)</check>
      <check>✅ UUID-based filename generation works correctly</check>
      <check>✅ Content-Type metadata set correctly in S3</check>
    </category>

    <category name="File Download Operations">
      <check>✅ Presigned URL generated successfully</check>
      <check>✅ Presigned URL downloads file correctly</check>
      <check>✅ Presigned URL expires after 5 minutes</check>
      <check>✅ Content-Disposition header provides correct filename</check>
      <check>✅ Presigned URL uses LocalStack endpoint in dev mode</check>
    </category>

    <category name="File Deletion Operations">
      <check>✅ Single file deletion removes file from S3</check>
      <check>✅ Batch file deletion removes multiple files</check>
      <check>✅ Deleting already-deleted file succeeds (idempotent)</check>
      <check>✅ Database record deletion triggers S3 file deletion</check>
    </category>

    <category name="Multi-Module Support">
      <check>✅ Lead document upload stores in leads/{leadId}/documents/</check>
      <check>✅ Property image upload stores in properties/{propertyId}/images/</check>
      <check>✅ Tenant document upload stores in tenants/{tenantId}/documents/</check>
      <check>✅ Maintenance attachment upload stores in maintenance/{requestId}/attachments/</check>
    </category>

    <category name="Configuration">
      <check>✅ application-dev.yml has aws.s3 configuration with LocalStack endpoint</check>
      <check>✅ application-prod.yml has aws.s3 configuration without endpoint</check>
      <check>✅ S3Config reads endpoint property and overrides if present</check>
      <check>✅ S3Presigner bean configured with same region and endpoint</check>
    </category>

    <category name="Integration Tests">
      <check>✅ S3ServiceImplTest covers all upload scenarios</check>
      <check>✅ FileStorageServiceIntegrationTest validates end-to-end flows</check>
      <check>✅ Tests run successfully with LocalStack</check>
      <check>✅ Tests clean up S3 files after execution</check>
    </category>

    <category name="Documentation">
      <check>✅ README documents LocalStack setup process</check>
      <check>✅ README includes troubleshooting section for S3 issues</check>
      <check>✅ Code comments explain S3 key patterns</check>
      <check>✅ Production deployment guide includes IAM policy requirements</check>
    </category>

    <category name="Error Handling">
      <check>✅ S3Exception wrapped in FileStorageException with clear message</check>
      <check>✅ Bucket not found error handled gracefully</check>
      <check>✅ Access denied error returns 403 with helpful message</check>
      <check>✅ Network errors logged with retry suggestions</check>
    </category>

    <category name="Backward Compatibility">
      <check>✅ LeadServiceImpl works without code changes (after refactor)</check>
      <check>✅ PropertyServiceImpl works without code changes</check>
      <check>✅ Deprecated methods (loadFile, getAbsolutePath) still function</check>
      <check>✅ No breaking changes to public interfaces</check>
    </category>
  </validation-checklist>

  <!-- ===================================================================== -->
  <!-- RISKS AND MITIGATION                                                   -->
  <!-- ===================================================================== -->
  <risks-and-mitigation>
    <risk level="high">
      <description>LocalStack not running when backend starts</description>
      <impact>S3 operations fail, application cannot start or file uploads fail</impact>
      <mitigation>
        <strategy>Add health check to LocalStack in docker-compose</strategy>
        <strategy>Update README with clear startup sequence: LocalStack → Backend</strategy>
        <strategy>Add retry logic in S3Config initialization (3 retries, 5-second delay)</strategy>
        <strategy>Log clear error message if S3 bucket not accessible on startup</strategy>
      </mitigation>
    </risk>

    <risk level="medium">
      <description>Presigned URL expiration too short for large files</description>
      <impact>Users may not complete download within 5-minute window</impact>
      <mitigation>
        <strategy>5 minutes is sufficient for files up to 5MB on typical connections</strategy>
        <strategy>Document expected download speeds (5MB in 5 min = 170 KB/s minimum)</strategy>
        <strategy>Allow retry/regenerate presigned URL if expired</strategy>
        <strategy>Consider configurable expiration time if user feedback indicates issues</strategy>
      </mitigation>
    </risk>

    <risk level="medium">
      <description>S3 credential misconfiguration in production</description>
      <impact>File uploads fail in production, operations disrupted</impact>
      <mitigation>
        <strategy>Use IAM roles (EC2 instance profile) instead of access keys</strategy>
        <strategy>Document required IAM policy permissions in README</strategy>
        <strategy>Add startup validation: attempt to list bucket on initialization</strategy>
        <strategy>Implement health check endpoint: GET /actuator/health/s3</strategy>
      </mitigation>
    </risk>

    <risk level="low">
      <description>File size limit too restrictive for some use cases</description>
      <impact>Users cannot upload larger documents (e.g., detailed contracts)</impact>
      <mitigation>
        <strategy>Standard limit is 5MB (sufficient for most PDFs and images)</strategy>
        <strategy>Lease agreements can be up to 10MB (already supported)</strategy>
        <strategy>Consider future enhancement: configurable limits per document type</strategy>
        <strategy>Implement multi-part upload for files > 5MB (future epic)</strategy>
      </mitigation>
    </risk>

    <risk level="low">
      <description>S3 costs increase with many file uploads</description>
      <impact>Higher than expected AWS costs</impact>
      <mitigation>
        <strategy>Implement S3 lifecycle policies (archive to Glacier after 3 years)</strategy>
        <strategy>Monitor S3 storage usage via AWS Cost Explorer</strategy>
        <strategy>Set up billing alerts for S3 usage</strategy>
        <strategy>Consider compression for large PDF files (future enhancement)</strategy>
      </mitigation>
    </risk>
  </risks-and-mitigation>

  <!-- ===================================================================== -->
  <!-- DEPENDENCIES AND BLOCKERS                                              -->
  <!-- ===================================================================== -->
  <dependencies-and-blockers>
    <prerequisites>
      <prerequisite status="completed">
        Story 1.1: Project Initialization - AWS SDK already in pom.xml ✅
      </prerequisite>
      <prerequisite status="completed">
        Story 1.2: PostgreSQL Database - Database entities (LeadDocument, PropertyImage) exist ✅
      </prerequisite>
      <prerequisite status="completed">
        Story 1.4: Core Domain Models - Entities with filePath column exist ✅
      </prerequisite>
      <prerequisite status="completed">
        Story 1.5: REST API Structure - FileStorageException and error handling exist ✅
      </prerequisite>
    </prerequisites>

    <blockers>
      <blocker status="none">
        No blockers identified. All prerequisites are complete.
      </blocker>
    </blockers>

    <downstream-dependencies>
      <dependency>
        Story 2.x (Authentication): May use S3 for profile pictures in future
      </dependency>
      <dependency>
        Story 3.x (Tenant Management): Already uses FileStorageService for document uploads
      </dependency>
      <dependency>
        Story 4.x (Maintenance): Already uses FileStorageService for work order photos
      </dependency>
      <dependency>
        Future epics: All document upload features will use this S3 integration
      </dependency>
    </downstream-dependencies>
  </dependencies-and-blockers>

  <!-- ===================================================================== -->
  <!-- COMPLETION CRITERIA                                                    -->
  <!-- ===================================================================== -->
  <completion-criteria>
    <criterion id="CC-1">
      LocalStack runs successfully via docker-compose with auto-created S3 bucket
    </criterion>
    <criterion id="CC-2">
      Backend application connects to LocalStack S3 on startup without errors
    </criterion>
    <criterion id="CC-3">
      FileStorageServiceImpl refactored to use S3Service for all file operations
    </criterion>
    <criterion id="CC-4">
      Lead document upload stores file in S3 and returns presigned download URL
    </criterion>
    <criterion id="CC-5">
      Property image upload stores file in S3 and returns presigned download URL
    </criterion>
    <criterion id="CC-6">
      File deletion removes S3 object successfully (idempotent operation)
    </criterion>
    <criterion id="CC-7">
      Presigned URLs expire after 5 minutes (not 1 hour)
    </criterion>
    <criterion id="CC-8">
      File size validation rejects files > 5MB
    </criterion>
    <criterion id="CC-9">
      File type validation rejects non-PDF/JPG/PNG files
    </criterion>
    <criterion id="CC-10">
      Integration tests pass for upload, download, delete flows with LocalStack
    </criterion>
    <criterion id="CC-11">
      README documents LocalStack setup and troubleshooting
    </criterion>
    <criterion id="CC-12">
      Production configuration exists (application-prod.yml) with real S3 settings
    </criterion>
  </completion-criteria>

</story-context>
