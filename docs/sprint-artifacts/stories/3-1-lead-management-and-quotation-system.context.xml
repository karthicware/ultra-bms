<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>1</storyId>
    <title>Lead Management and Quotation System</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-1-lead-management-and-quotation-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>property manager</asA>
    <iWant>to manage potential tenant leads and create quotations</iWant>
    <soThat>I can track prospects and convert them to tenants efficiently</soThat>
    <tasks>
- Task 1: Define TypeScript Types and Enums (types/leads.ts, types/quotations.ts)
- Task 2: Create Zod Validation Schemas (lib/validations/leads.ts, quotations.ts)
- Task 3: Implement Lead Service Layer (services/leads.service.ts)
- Task 4: Implement Quotation Service Layer (services/quotations.service.ts)
- Task 5: Create Lead List Page (app/(dashboard)/leads/page.tsx)
- Task 6: Create Lead Detail Page (app/(dashboard)/leads/[id]/page.tsx)
- Task 7: Create Lead Create/Edit Form
- Task 8: Create Quotation List Page
- Task 9: Create Quotation Form
- Task 10: Implement Quotation Dashboard with KPIs
- Task 11: Implement PDF Generation (backend iText)
- Task 12: Implement Email Sending with PDF attachment
- Task 13: Implement Status Management workflows
- Task 14: Implement Lead to Tenant Conversion
- Task 15: Implement Communication History timeline
- Task 16: Add Responsive Design and Accessibility
- Task 17: Write Tests (E2E with Playwright, Unit tests)
- Task 18: Documentation (API docs, JSDoc, developer guide)
    </tasks>
  </story>

  <acceptanceCriteria>
1. **AC1 - Lead Creation and Management:** Property manager can create leads via POST /api/v1/leads with required fields (name, Emirates ID, passport, email, phone, lead source). Frontend displays leads list at /leads with filters, search, and quick actions. Lead detail page shows all information, documents, communication history, and quotations.

2. **AC2 - Document Upload for Leads:** Leads can have multiple documents (Emirates ID, passport, marriage certificate) via POST /api/v1/leads/{id}/documents. Validates file type (PDF/JPG/PNG), max 5MB. Frontend shows document list with download/delete options.

3. **AC3 - Quotation Creation:** From lead detail, property manager creates quotation with: property/unit selection, rent details, security deposit, admin fee, parking, document requirements, terms. Backend creates Quotation entity via POST /api/v1/quotations. Frontend uses React Hook Form + Zod with real-time total calculation.

4. **AC4 - Quotation PDF Generation:** Quotation PDF via GET /api/v1/quotations/{id}/pdf includes company header, quotation details, rent breakdown table, terms, validity date. Use iText library. Frontend has "Download PDF" and "Send via Email" buttons.

5. **AC5 - Quotation Status Management:** Quotations workflow: DRAFT → SENT → (ACCEPTED | REJECTED | EXPIRED). Quotations emailed with PDF attachment. Manager can manually mark as accepted/rejected. Scheduled job expires quotations daily. Frontend shows color-coded status badges.

6. **AC6 - Quotation Dashboard and Analytics:** Dashboard at /leads-quotes shows KPI cards (new quotes, converted, conversion rate, avg time to convert), sales funnel chart, and "Quotes Expiring Soon" table with color-coded rows. Use Recharts for visualization.

7. **AC7 - Lead to Tenant Conversion:** When quotation accepted, "Convert to Tenant" button pre-populates tenant onboarding form with lead/quotation data. Links tenant to lead/quotation. Updates statuses and unit to RESERVED.

8. **AC8 - Lead Search and Filtering:** Leads list supports text search, multi-select filters (status, property, source), date range. Backend GET /api/v1/leads with pagination. Frontend uses shadcn Select/Checkbox with 300ms debounce.

9. **AC9 - Quotation List and Management:** Quotations list at /quotations shows all quotations with filters. Quick actions: View, Edit (if DRAFT), Send, Download PDF. Uses shadcn Table and AlertDialog.

10. **AC10 - Email Notifications:** POST /api/v1/quotations/{id}/send sends email with quotation PDF attachment using Spring Mail + Gmail API. Email template uses Thymeleaf. Frontend shows success toast.

11. **AC11 - Lead Communication History:** Lead detail page has timeline of interactions (created, document uploaded, quotation created/sent, status changed). Stored in LeadHistory entity. Frontend displays as vertical timeline, sorted newest first.

12. **AC12 - Form Validation and Error Handling:** Lead form validates Emirates ID format, email RFC 5322, phone E.164. Quotation form validates rent > 0, validity date > issue date. Frontend uses Zod with inline errors. Backend returns 400 with field-specific errors.

13. **AC13 - TypeScript Types and API Integration:** Define types in types/leads.ts and types/quotations.ts. Create Zod schemas in lib/validations/. Create services in services/leads.service.ts and quotations.service.ts using Axios from lib/api.ts. Follow API Integration Layer pattern.

14. **AC14 - Responsive Design and UX:** All pages responsive (mobile/desktop). Touch targets min 44×44px. Loading states with Skeleton. Success/error feedback with toast. Real-time calculations. shadcn dark theme support. Keyboard navigable with ARIA labels.

15. **AC15 - Testing and Documentation:** E2E tests with Playwright for full flows. Unit tests for services and schemas. Test PDF generation. Document API endpoints. Add JSDoc. All interactive elements have data-testid attributes following conventions.
  </acceptanceCriteria>

  <artifacts>
    <docs>
<!-- Epic 3: Tenant Management & Portal -->
<doc path="docs/epics/epic-3-tenant-management-portal.md" title="Epic 3: Tenant Management & Portal" section="Story 3.1">
Story definition with detailed acceptance criteria for lead management and quotation system. Includes entity structures, API endpoints, PDF generation requirements, email integration, and dashboard analytics.
</doc>

<!-- API Integration Layer Pattern -->
<doc path="docs/patterns/api-integration-layer-epic3.md" title="API Integration Layer Design - Epic 3" section="Overview">
Complete API integration architecture for Epic 3. Defines type structure (types/leads.ts, types/quotations.ts), validation schemas (Zod), service layer pattern (services/leads.service.ts), and React Query integration. Follows patterns from Epic 2 with examples.
</doc>

<!-- Testing Standards -->
<doc path="docs/data-testid-conventions.md" title="data-testid Naming Conventions" section="Naming Convention">
MANDATORY from Epic 3: All interactive elements MUST have data-testid attributes following pattern: {component}-{element}-{action}. Examples: btn-create-lead, form-lead-create, input-lead-name, table-leads. Includes component-specific conventions for buttons, forms, inputs, tables, modals, navigation.
</doc>

<!-- Definition of Done -->
<doc path="docs/definition-of-done.md" title="Definition of Done Checklist" section="Story Completion Criteria">
All stories must meet DoD criteria including: all ACs met, data-testid on ALL interactive elements, servers verified before tests (scripts/check-services.sh), test coverage thresholds (backend 80%, frontend 70%), completion notes mandatory, sprint-status.yaml updated in same commit.
</doc>

<!-- Epic 2 Retrospective Learnings -->
<doc path="docs/sprint-artifacts/sprint-status.yaml" title="Sprint Status - Epic 2 Action Items" section="action_items">
P0 Action Items (BLOCKING for Epic 3):
- AI-2-1: Add data-testid to ALL interactive elements (MANDATORY)
- AI-2-2: Create pre-test validation script (scripts/check-services.sh)
- AI-2-3: Update workflow with server validation before tests
- AI-2-4: Update DoD checklist with new mandatory items
P1 Action Items: Completion notes mandatory, sprint-status.yaml updates, test coverage thresholds, API integration layer design
</doc>
    </docs>

    <code>
<!-- Axios API Client (REUSE) -->
<artifact path="frontend/src/lib/api.ts" kind="api-client" symbol="apiClient" lines="1-156" reason="Axios instance with auto token refresh, CSRF protection, request/response interceptors. REUSE for all Epic 3 API calls. Already configured with baseURL, timeout, withCredentials. Handles 401 with automatic refresh token flow."/>

<!-- TypeScript Types Pattern (REFERENCE) -->
<artifact path="frontend/src/types/auth.ts" kind="types" symbol="User, LoginRequest, RegisterRequest" lines="1-239" reason="Reference pattern for creating types/leads.ts and types/quotations.ts. Shows proper interface structure matching backend DTOs, enums, request/response types, form data types."/>

<!-- Frontend Dependencies -->
<artifact path="frontend/package.json" kind="config" lines="24-46" reason="Dependencies available: axios (1.13.2), react-hook-form (7.66.0), zod (4.1.12), recharts (3.4.1), sonner (2.0.7), @hookform/resolvers (5.2.2). All needed dependencies already installed. Recharts for sales funnel visualization."/>

<!-- Backend Framework -->
<artifact path="backend/pom.xml" kind="config" lines="1-100" reason="Spring Boot 3.4.0, Java 17, PostgreSQL, Spring Security, Spring Mail, Thymeleaf for email templates. Need to ADD: iText library for PDF generation (com.itextpdf:itext7-core:7.2.5)."/>

<!-- Backend Entity Pattern (REFERENCE) -->
<artifact path="backend/src/main/java/com/ultrabms/entity" kind="entities" symbol="Property, Unit, User, Role" reason="Reference entity patterns for creating Lead, Quotation, LeadDocument, LeadHistory entities. Use JPA annotations, BaseEntity for auditing (createdAt/updatedAt), UUID IDs, enums for status fields."/>

<!-- Backend Controller Pattern (REFERENCE) -->
<artifact path="backend/src/main/java/com/ultrabms/controller/AuthController.java" kind="controller" reason="Reference REST controller pattern for LeadController and QuotationController. Use @RestController, @RequestMapping, @Valid for validation, ResponseEntity for responses, standard error handling."/>

<!-- Backend DTO Pattern (REFERENCE) -->
<artifact path="backend/src/main/java/com/ultrabms/dto/RegisterRequest.java" kind="dto" reason="Reference DTO pattern for CreateLeadRequest, CreateQuotationRequest. Use javax.validation annotations (@NotBlank, @Email, @Pattern), nested validation, builder pattern if needed."/>

<!-- Email Service (REUSE) -->
<artifact path="backend/src/main/java/com/ultrabms/service/EmailService.java" kind="service" symbol="EmailService" reason="REUSE existing email service for sending quotation PDFs. Already configured with Spring Mail + Gmail API. Add new method sendQuotationEmail(String to, String subject, File pdfAttachment)."/>

<!-- shadcn/ui Components (REUSE) -->
<artifact path="frontend/src/components/ui" kind="components" symbol="Button, Input, Form, Card, Table, Dialog, Select, Checkbox" reason="REUSE shadcn/ui components for all UI: Button (btn-*), Input (input-*), Form (form-*), Table (table-*), Dialog (modal-*), Select (select-*), Card (card-*). Already installed and working."/>

<!-- Form Components Pattern (REUSE) -->
<artifact path="frontend/src/components/forms/submit-button.tsx" kind="component" symbol="SubmitButton" reason="Reference for creating form components with loading states. Pattern: disabled={isSubmitting}, show loading text during submit."/>

<!-- Auth Context (REFERENCE) -->
<artifact path="frontend/src/contexts/auth-context.tsx" kind="context" symbol="AuthContext, useAuth" reason="Reference for checking authentication and user permissions. Use useAuth() hook to verify PROPERTY_MANAGER role for lead/quotation features."/>
    </code>

    <dependencies>
<!-- Frontend (All Already Installed) -->
<frontend>
  <package>axios@1.13.2</package>
  <package>react-hook-form@7.66.0</package>
  <package>zod@4.1.12</package>
  <package>@hookform/resolvers@5.2.2</package>
  <package>recharts@3.4.1</package>
  <package>sonner@2.0.7</package>
  <package>lucide-react@0.553.0</package>
  <package>date-fns@4.1.0</package>
</frontend>

<!-- Backend (Need to ADD iText) -->
<backend>
  <dependency groupId="com.itextpdf" artifactId="itext7-core" version="7.2.5" scope="compile" reason="PDF generation for quotations"/>
  <existing>Spring Boot 3.4.0, PostgreSQL, Spring Security, Spring Mail, Thymeleaf, EHCache, Flyway</existing>
</backend>
    </dependencies>
  </artifacts>

  <constraints>
1. **MANDATORY (P0 - BLOCKING):** ALL interactive elements MUST have data-testid attributes following convention: {component}-{element}-{action} (e.g., btn-create-lead, form-lead-create, input-lead-name, table-leads, modal-confirm-send)

2. **MANDATORY (P0):** Before running E2E tests, MUST execute scripts/check-services.sh to verify backend (port 8080) and frontend (port 3000) servers are healthy

3. **MANDATORY (P0):** Completion notes are REQUIRED with same quality as Story 2-5: list all files created/modified, all dependencies added, test results, any deviations from ACs

4. **MANDATORY (P0):** Update sprint-status.yaml status in same commit as final code when marking story done

5. **API Integration Pattern:** MUST follow docs/patterns/api-integration-layer-epic3.md pattern - create types/leads.ts, types/quotations.ts, lib/validations/, services/ layer, use existing lib/api.ts

6. **Reuse Existing Patterns:** MUST reuse lib/api.ts (Axios client), React Hook Form + Zod validation, shadcn/ui components, existing EmailService

7. **Backend Conventions:** REST API at /api/v1/leads, /api/v1/quotations with pagination. Use JPA entities extending BaseEntity. Use @Valid for validation. Return standard ResponseEntity format.

8. **Database Schema:** leads table (id UUID, leadNumber unique, fullName, emiratesId, passportNumber, email, contactNumber, leadSource enum, status enum), quotations table (id UUID, quotationNumber unique, leadId FK, propertyId FK, unitId FK, baseRent, securityDeposit, status enum), lead_documents, lead_history

9. **Security:** Protected routes require PROPERTY_MANAGER or SUPER_ADMIN role (RBAC from Story 2.2). File upload validation (PDF/JPG/PNG, max 5MB). Email rate limiting to prevent spam.

10. **File Storage:** Store lead documents in /uploads/leads/{leadId}/documents/ with original filename preserved. Store with UUID filename for security.

11. **Email Integration:** Use Spring Mail with Gmail API (already configured from Story 2.3). Email template at resources/templates/quotation-email.html with Thymeleaf variables. Attach PDF to email.

12. **PDF Generation:** Use iText library to generate quotation PDFs. Include company header, quotation details, rent breakdown table, terms, validity date. Match company branding.

13. **Real-time Calculation:** Quotation form must calculate totalFirstPayment in real-time: securityDeposit + adminFee + baseRent + serviceCharges + (parkingSpots × parkingFee)

14. **Testing Standards:** E2E tests cover: create lead → upload document → create quotation → send quotation → accept → convert to tenant. Unit tests for services and Zod schemas. Test PDF generation. Coverage: backend ≥80%, frontend ≥70%.

15. **Responsive Design:** Single column on mobile (<640px), multi-column on desktop. Touch targets ≥44×44px. Dark theme support. Keyboard navigation with ARIA labels.
  </constraints>

  <interfaces>
<!-- Lead Management APIs -->
<api name="POST /api/v1/leads" kind="REST" signature="CreateLeadRequest → Lead" path="backend/src/main/java/com/ultrabms/controller/LeadController.java">
Request: { fullName, emiratesId, passportNumber, passportExpiryDate, homeCountry, email, contactNumber, leadSource, notes }
Response: { id, leadNumber, ...all fields..., status: "NEW", createdAt, updatedAt }
</api>

<api name="GET /api/v1/leads" kind="REST" signature="LeadSearchParams → LeadListResponse" path="backend/src/main/java/com/ultrabms/controller/LeadController.java">
Query params: page, size, sort, direction, status[], propertyId, leadSource[], searchTerm, dateFrom, dateTo
Response: { content: Lead[], totalElements, totalPages, currentPage, pageSize }
</api>

<api name="GET /api/v1/leads/{id}" kind="REST" signature="id → Lead" path="backend/src/main/java/com/ultrabms/controller/LeadController.java"/>

<api name="POST /api/v1/leads/{id}/documents" kind="REST" signature="File, documentType → LeadDocument" path="backend/src/main/java/com/ultrabms/controller/LeadController.java">
Multipart form-data with file upload. Validates PDF/JPG/PNG, max 5MB. Returns { id, leadId, documentType, fileName, filePath, uploadedAt }
</api>

<!-- Quotation Management APIs -->
<api name="POST /api/v1/quotations" kind="REST" signature="CreateQuotationRequest → Quotation" path="backend/src/main/java/com/ultrabms/controller/QuotationController.java">
Request: { leadId, issueDate, validityDate, propertyId, unitId, stayType, baseRent, serviceCharges, parkingSpots, parkingFee, securityDeposit, adminFee, documentRequirements[], paymentTerms, moveinProcedures, cancellationPolicy, specialTerms }
Response: { id, quotationNumber, ...all fields..., totalFirstPayment (calculated), status: "DRAFT", createdAt }
</api>

<api name="POST /api/v1/quotations/{id}/send" kind="REST" signature="id → void" path="backend/src/main/java/com/ultrabms/controller/QuotationController.java">
Sends email with PDF attachment. Updates status to SENT, sets sentAt timestamp.
</api>

<api name="GET /api/v1/quotations/{id}/pdf" kind="REST" signature="id → Blob" path="backend/src/main/java/com/ultrabms/controller/QuotationController.java">
Returns PDF file as application/pdf. Generated using iText library.
</api>

<api name="PATCH /api/v1/quotations/{id}/accept" kind="REST" signature="id → Quotation" path="backend/src/main/java/com/ultrabms/controller/QuotationController.java">
Updates status to ACCEPTED, sets acceptedAt timestamp.
</api>

<api name="POST /api/v1/quotations/{id}/convert" kind="REST" signature="id → void" path="backend/src/main/java/com/ultrabms/controller/QuotationController.java">
Converts lead to tenant. Pre-populates tenant form. Links tenant.leadId and tenant.quotationId. Updates statuses to CONVERTED, unit to RESERVED.
</api>

<api name="GET /api/v1/leads-quotes/dashboard" kind="REST" signature="void → QuotationDashboard" path="backend/src/main/java/com/ultrabms/controller/QuotationController.java">
Returns { newQuotes, quotesConverted, conversionRate, avgTimeToConvert, expiringQuotes[] }
</api>

<!-- TypeScript Service Interfaces -->
<interface name="leadsService" kind="TypeScript" signature="Various methods" path="frontend/src/services/leads.service.ts">
createLead(data: CreateLeadRequest): Promise<Lead>
getLeads(params: LeadSearchParams): Promise<LeadListResponse>
getLeadById(id: string): Promise<Lead>
updateLead(id: string, data: UpdateLeadRequest): Promise<Lead>
uploadDocument(leadId: string, file: File, type: string): Promise<LeadDocument>
getLeadHistory(leadId: string): Promise<LeadHistory[]>
</interface>

<interface name="quotationsService" kind="TypeScript" signature="Various methods" path="frontend/src/services/quotations.service.ts">
createQuotation(data: CreateQuotationRequest): Promise<Quotation>
getQuotations(params: QuotationSearchParams): Promise<QuotationListResponse>
sendQuotation(id: string): Promise<void>
acceptQuotation(id: string): Promise<Quotation>
rejectQuotation(id: string, reason: string): Promise<Quotation>
generatePDF(id: string): Promise<Blob>
convertToTenant(id: string): Promise<void>
getDashboardMetrics(): Promise<QuotationDashboard>
</interface>
  </interfaces>

  <tests>
    <standards>
Testing Framework: Playwright for E2E, Jest for unit tests
Coverage Requirements: Backend ≥80% line/≥70% branch, Frontend ≥70% line/≥60% branch
Pre-test Validation: MUST run scripts/check-services.sh before E2E tests to verify servers running
Test Attributes: ALL interactive elements MUST have data-testid following {component}-{element}-{action} pattern
Test Execution: Use package.json scripts - npm run test:e2e runs check-services.sh then playwright test
Backend: JUnit tests for services, controllers, repositories. Use @SpringBootTest, @MockBean
Frontend: Jest + React Testing Library for component tests, Playwright for E2E flows
    </standards>

    <locations>
frontend/tests/e2e/leads-quotations.spec.ts - E2E tests
frontend/src/services/__tests__/leads.service.test.ts - Unit tests
frontend/src/lib/validations/__tests__/leads.test.ts - Validation schema tests
backend/src/test/java/com/ultrabms/controller/LeadControllerTest.java
backend/src/test/java/com/ultrabms/service/LeadServiceImplTest.java
backend/src/test/java/com/ultrabms/service/QuotationPdfServiceTest.java
    </locations>

    <ideas>
E2E Test Ideas (mapped to ACs):
- AC1: Create lead with all fields → verify in list → view detail page
- AC2: Upload document (PDF, JPG) → verify appears in list → download → delete
- AC3: Create quotation from lead → verify calculated total → save as draft
- AC4: Generate PDF → verify download → check PDF contains all sections
- AC5: Send quotation → verify email sent → verify status changed to SENT
- AC6: View dashboard → verify KPIs calculate correctly → verify sales funnel chart displays
- AC7: Accept quotation → click "Convert to Tenant" → verify tenant form pre-filled
- AC8: Search leads by email → filter by status → verify pagination works
- AC9: View quotations list → filter by property → quick action Send
- AC10: Send quotation with PDF attachment (verify manually or use test email)
- AC11: View lead communication history timeline → verify events sorted newest first
- AC12: Submit form with invalid Emirates ID → verify inline error → fix → submit success
- AC13: Service layer tests - mock Axios, verify API calls made correctly
- AC14: Responsive design - test mobile (375px), tablet (768px), desktop (1920px)
- AC15: Test all data-testid attributes present, test coverage meets thresholds

Unit Test Ideas:
- Zod schema: Test Emirates ID regex XXX-XXXX-XXXXXXX-X, email RFC 5322, phone E.164
- Service layer: Mock apiClient, test createLead, getLeads, uploadDocument
- Real-time calculation: Test totalFirstPayment = securityDeposit + adminFee + baseRent + serviceCharges + (parkingSpots × parkingFee)
- Backend: Test lead creation, document upload, quotation PDF generation, email sending
- Test quotation expiry scheduled job updates status to EXPIRED when validityDate < today
    </ideas>
  </tests>
</story-context>
