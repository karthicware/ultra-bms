<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Ehcache Configuration for Application Caching</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-ehcache-configuration-for-application-caching.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a backend developer</asA>
    <iWant>Ehcache configured for application-level caching</iWant>
    <soThat>frequently accessed data is cached in-memory for performance optimization</soThat>
    <tasks>
- [ ] **Task 1: Add Ehcache Dependencies to pom.xml** (AC: #1)
  - [x] Add `org.ehcache:ehcache:3.10.8` dependency (Ehcache 3.x) - ALREADY PRESENT in pom.xml:75-79
  - [x] Add `javax.cache:cache-api:1.1.1` dependency (JSR-107 JCache API) - ALREADY PRESENT in pom.xml:80-84
  - [x] Verify spring-boot-starter-cache already present (from Story 1.1) - PRESENT in pom.xml:38-40
  - [ ] Run `./mvnw dependency:tree` to verify no conflicts
  - [ ] Run `./mvnw clean install` to download dependencies

- [ ] **Task 2: Enable Spring Cache Abstraction** (AC: #1)
  - [ ] Add `@EnableCaching` annotation to UltraBmsApplication.java main class
  - [ ] Configure `spring.cache.type=jcache` in application-dev.yml
  - [ ] Configure `spring.cache.jcache.config=classpath:ehcache.xml` to specify config file location
  - [ ] Add cache-related logging: `logging.level.org.springframework.cache=DEBUG` for development
  - [ ] Add ehcache logging: `logging.level.org.ehcache=INFO`

- [ ] **Task 3: Create ehcache.xml Configuration File** (AC: #2)
  - [ ] Create `backend/src/main/resources/ehcache.xml` file
  - [ ] Define XML namespace and schema: `http://www.ehcache.org/v3`
  - [ ] Configure heap memory resource: `<heap unit="MB">100</heap>`
  - [ ] Define userCache: 1000 entries, 30 min TTL, LRU eviction
  - [ ] Define sessionCache: 5000 entries, 24 hour TTL, LRU eviction
  - [ ] Define tenantCache: 2000 entries, 1 hour TTL, LRU eviction
  - [ ] Define propertyCache: 500 entries, 2 hour TTL, LRU eviction
  - [ ] Define lookupCache: 10000 entries, 12 hour TTL, LRU eviction
  - [ ] Enable statistics for all cache regions (for monitoring)

- [ ] **Task 4: Configure Cache Monitoring** (AC: #3)
  - [ ] Verify Actuator dependency present (confirmed from Story 1.2) - PRESENT in pom.xml:34-36
  - [ ] Enable cache endpoint: `management.endpoints.web.exposure.include=health,info,caches` in application-dev.yml
  - [ ] Enable JMX: `spring.jmx.enabled=true` (default in Spring Boot)
  - [ ] Configure management metrics: `management.metrics.enable.cache=true`
  - [ ] Add cache statistics logging configuration (optional)

- [ ] **Task 5: Update README with Caching Documentation** (AC: #4)
  - [ ] Add "Caching Setup" section after "Database Setup" in README.md
  - [ ] Document Ehcache configuration and cache regions
  - [ ] Explain caching annotations with code examples
  - [ ] Document cache key generation strategies (default vs custom)
  - [ ] Explain monitoring via /actuator/caches endpoint
  - [ ] Add JMX monitoring instructions (JConsole/VisualVM connection)
  - [ ] Document cache troubleshooting (clearing cache, memory tuning)

- [ ] **Task 6: Test Cache Configuration** (AC: #5)
  - [ ] **MANUAL TEST:** Start Spring Boot application: `cd backend && ./mvnw spring-boot:run`
  - [ ] **MANUAL TEST:** Verify application logs show Ehcache initialization messages
  - [ ] **MANUAL TEST:** Check logs for all 5 cache regions created
  - [ ] **MANUAL TEST:** Access /actuator/caches endpoint: `curl http://localhost:8080/actuator/caches`
  - [ ] **MANUAL TEST:** Verify JSON response shows cacheNames array with all 5 caches
  - [ ] **MANUAL TEST:** Check cache statistics show 0 size, 0 hits, 0 misses initially
  - [ ] **MANUAL TEST:** Connect via JConsole to view Ehcache MBeans (optional)

- [ ] **Task 7: Create Example Cacheable Service (Optional Demo)** (AC: #4)
  - [ ] Create simple service method with @Cacheable annotation (for documentation example)
  - [ ] Example: `@Cacheable("lookupCache") public List&lt;String&gt; getRoles()`
  - [ ] Add to README as working example of cache usage
  - [ ] Note: Actual caching will be implemented in later stories when services are built
    </tasks>
  </story>

  <acceptanceCriteria>
1. **AC1 - Spring Cache Configuration:** @EnableCaching annotation added to UltraBmsApplication.java main class, Ehcache 3.x configured as cache provider via spring.cache.type=jcache, JSR-107 (JCache) API dependency added to pom.xml.

2. **AC2 - Ehcache XML Configuration:** ehcache.xml file created in backend/src/main/resources/ with 5 cache regions defined:
   - userCache: max 1000 entries, TTL 30 minutes
   - sessionCache: max 5000 entries, TTL 24 hours
   - tenantCache: max 2000 entries, TTL 1 hour
   - propertyCache: max 500 entries, TTL 2 hours
   - lookupCache: max 10000 entries, TTL 12 hours
   - Heap memory allocation: 100 MB total across all caches
   - Eviction policy: LRU (Least Recently Used)

3. **AC3 - Cache Monitoring Configuration:** Statistics enabled in ehcache.xml for all cache regions, Actuator /actuator/caches endpoint accessible and showing cache details, JMX beans enabled for monitoring via JConsole/VisualVM, cache metrics exposed via Spring Boot Actuator.

4. **AC4 - Documentation:** README.md updated with "Caching Setup" section explaining Ehcache configuration, caching annotations documented (@Cacheable, @CachePut, @CacheEvict, @Caching), cache key generation strategies explained, monitoring guide for cache statistics.

5. **AC5 - Verification:** Application starts successfully with cache configuration loaded, Actuator endpoint shows all 5 cache regions initialized, cache statistics are accessible and show 0 hits/misses initially, logs confirm Ehcache initialization with configured regions.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- PRD: Performance Requirements Section -->
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document - Ultra BMS</title>
        <section>5.5 Performance Requirements</section>
        <snippet>Response Time: &lt; 200ms for API calls. Caching helps achieve this by reducing database query time from ~50-100ms to &lt;10ms for cached reads. Concurrent Users: Support 10,000+ simultaneous users. Uptime: 99.9% availability SLA.</snippet>
      </doc>

      <!-- Architecture: Caching Decision (ADR-002) -->
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document - Ultra BMS</title>
        <section>ADR-002: No Redis, Use Spring Cache with Caffeine/Ehcache</section>
        <snippet>Decision: Use Spring Boot's built-in caching with Ehcache as the cache provider. Rationale: Simplifies deployment (no external cache server), sufficient for monolithic architecture, lower operational overhead, good performance for application-level caching, easy to migrate to Redis later if needed. Consequences: Cache is not shared across instances (acceptable for now), limited to JVM memory constraints, may need Redis in future for distributed caching.</snippet>
      </doc>

      <!-- Architecture: Caching Implementation Pattern -->
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document - Ultra BMS</title>
        <section>Performance Considerations - Caching Strategy</section>
        <snippet>Application-Level Caching (Ehcache): Configure CacheManager with Ehcache provider, define cache regions (users, properties, tenants, vendors) with TTL and eviction policies. Usage: @Cacheable for read operations, @CachePut for write operations, @CacheEvict for delete operations. Example: @Cacheable(value = "tenants", key = "#id") on findById methods.</snippet>
      </doc>

      <!-- Tech Spec: Cache Service Specification -->
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Platform Foundation &amp; Infrastructure</title>
        <section>Services and Modules - Cache Service</section>
        <snippet>Cache Service: In-memory caching layer using Ehcache 3.x, Spring Cache abstraction. Input: Cache configs → Cache regions. Owner: Story 1.3. Cache regions: userCache (1000/30min), sessionCache (5000/24h), tenantCache (2000/1h), propertyCache (500/2h), lookupCache (10000/12h). Heap memory: 100 MB max allocation. Eviction: LRU when capacity reached. Cache hit rate target: &gt; 80% after warm-up.</snippet>
      </doc>

      <!-- Tech Spec: Dependencies - Caching -->
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Platform Foundation &amp; Infrastructure</title>
        <section>Backend Dependencies (Maven) - Caching</section>
        <snippet>org.ehcache:ehcache:3.10.8 (In-memory cache provider), javax.cache:cache-api:1.1.1 (JSR-107 JCache API). These dependencies enable Spring Cache abstraction to use Ehcache 3.x as the caching provider with JSR-107 standard API compliance.</snippet>
      </doc>

      <!-- Tech Spec: Non-Functional Requirements - Caching Performance -->
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Platform Foundation &amp; Infrastructure</title>
        <section>Non-Functional Requirements - Performance - Caching</section>
        <snippet>Heap memory allocation: 100 MB max for all cache regions. Cache eviction: LRU (Least Recently Used) when capacity reached. TTL ranges: 30 minutes (users) to 12 hours (lookup data). Ehcache hit rate: &gt; 80% for cached entities after warm-up. Response time for cached reads: &lt; 10ms vs database reads ~50-100ms.</snippet>
      </doc>
    </docs>

    <code>
      <!-- pom.xml: Maven Dependencies -->
      <artifact>
        <path>backend/pom.xml</path>
        <kind>build configuration</kind>
        <symbol>dependencies</symbol>
        <lines>32-113</lines>
        <reason>Contains spring-boot-starter-cache (line 38-40), ehcache:3.10.8 (line 75-79), and cache-api:1.1.1 (line 80-84). Dependencies are ALREADY present, Task 1 is mostly verification. Also contains Actuator dependency (line 34-36) needed for cache monitoring endpoint.</reason>
      </artifact>

      <!-- UltraBmsApplication.java: Main Application Class -->
      <artifact>
        <path>backend/src/main/java/com/ultrabms/UltraBmsApplication.java</path>
        <kind>application configuration</kind>
        <symbol>UltraBmsApplication</symbol>
        <lines>1-13</lines>
        <reason>Main Spring Boot application class. Currently has @SpringBootApplication annotation only. Needs @EnableCaching annotation added to activate Spring Cache abstraction (Task 2, AC1).</reason>
      </artifact>

      <!-- application-dev.yml: Development Configuration -->
      <artifact>
        <path>backend/src/main/resources/application-dev.yml</path>
        <kind>configuration file</kind>
        <symbol>spring configuration</symbol>
        <lines>1-32</lines>
        <reason>Contains datasource and JPA configuration. Needs cache configuration added: spring.cache.type=jcache, spring.cache.jcache.config=classpath:ehcache.xml, cache endpoint exposure in management.endpoints, and cache logging levels (Task 2, Task 4, AC1, AC3).</reason>
      </artifact>

      <!-- README.md: Developer Documentation -->
      <artifact>
        <path>README.md</path>
        <kind>documentation</kind>
        <symbol>project documentation</symbol>
        <lines>1-318</lines>
        <reason>Contains comprehensive Database Setup section (lines 32-253). Needs new "Caching Setup" section added after Database Setup to document Ehcache configuration, caching annotations, monitoring endpoints, and troubleshooting (Task 5, AC4).</reason>
      </artifact>

      <!-- ehcache.xml: Cache Configuration (TO BE CREATED) -->
      <artifact>
        <path>backend/src/main/resources/ehcache.xml</path>
        <kind>configuration file</kind>
        <symbol>ehcache configuration</symbol>
        <lines>N/A - file does not exist yet</lines>
        <reason>FILE DOES NOT EXIST. Must be created with 5 cache regions (userCache, sessionCache, tenantCache, propertyCache, lookupCache) with specified TTLs, entry limits, heap allocation (100MB), and statistics enabled (Task 3, AC2). Reference implementation provided in story Dev Notes section.</reason>
      </artifact>
    </code>

    <dependencies>
      <maven>
        <dependency name="spring-boot-starter-cache" version="3.4.0" scope="compile" status="present">Spring Cache abstraction for declarative caching support</dependency>
        <dependency name="ehcache" version="3.10.8" scope="compile" status="present">Ehcache 3.x JSR-107 compliant in-memory cache provider</dependency>
        <dependency name="cache-api" version="1.1.1" scope="compile" status="present">JSR-107 JCache API standard for cache abstraction</dependency>
        <dependency name="spring-boot-starter-actuator" version="3.4.0" scope="compile" status="present">Production-ready features including /actuator/caches endpoint for monitoring</dependency>
        <dependency name="lombok" version="1.18.36" scope="provided" status="present">Boilerplate reduction for Java code</dependency>
      </maven>
    </dependencies>
  </artifacts>

  <constraints>
- **Architecture Decision (ADR-002):** Use Ehcache instead of Redis for application-level caching. Rationale: Simplifies deployment, no external cache server needed, sufficient for monolith architecture. Cache is in-process, not distributed across instances.

- **No Distributed Cache:** Cache is not shared across application instances. This is acceptable for single-instance local development. Future scaling may require Redis or distributed cache.

- **Heap Memory Limit:** Maximum 100 MB heap allocation across all cache regions to prevent memory exhaustion. Monitor via JMX and Actuator metrics.

- **Eviction Policy:** LRU (Least Recently Used) eviction when cache capacity reached. Ensures most frequently accessed data remains cached while least-used entries are evicted.

- **Technology Constraint:** Must use Ehcache 3.x (JSR-107 compliant) with Spring Cache abstraction. No custom cache implementation. Leverages Spring Boot auto-configuration.

- **Configuration Pattern:** Declarative cache configuration via ehcache.xml. No programmatic cache setup. Enables easy tuning without code changes.

- **Caching Layer:** Application-level caching only. Database query caching handled separately by Hibernate second-level cache (if enabled in future). File caching out of scope.

- **Testing Approach:** Manual verification via Actuator endpoints, JMX monitoring, and application logs. Automated cache testing deferred to later stories when services implement @Cacheable methods.

- **Development Environment:** Local development uses same caching setup as production (Ehcache in-memory). No separate dev cache configuration needed.
  </constraints>

  <interfaces>
- **Spring Cache Abstraction API:**
  - @EnableCaching: Enables Spring's annotation-driven cache management
  - @Cacheable(value="cacheName", key="#param"): Cache method results on read operations
  - @CachePut(value="cacheName", key="#param"): Update cache on write operations
  - @CacheEvict(value="cacheName", key="#param"): Remove from cache on delete operations
  - @Caching: Combine multiple cache operations

- **Actuator Cache Monitoring Endpoint:**
  - GET /actuator/caches: Returns list of all cache regions and their configuration
  - Response format: { "cacheManagers": { "cacheManager": { "caches": { "cacheName": { "target": "..." } } } } }

- **JMX Monitoring Interface:**
  - MBeans: org.ehcache → CacheManager → caches → [cacheName]
  - Metrics: Size, Hits, Misses, HitPercentage, Evictions
  - Access via: JConsole, VisualVM, or Spring Boot Actuator metrics

- **Ehcache XML Schema:**
  - Namespace: http://www.ehcache.org/v3
  - JSR-107 extension: http://www.ehcache.org/v3/jsr107
  - Configuration elements: heap, ttl, resources, cache alias
  </interfaces>

  <tests>
    <standards>
Testing for this configuration story is primarily manual verification using Spring Boot Actuator endpoints, JMX monitoring tools, and application logs. Automated testing is deferred to later stories when services implement actual @Cacheable methods.

**Frameworks:** Manual testing via curl (Actuator endpoints), JConsole/VisualVM (JMX monitoring), application console logs (Ehcache initialization).

**Test Approach:** Configuration validation (ehcache.xml schema, Spring Boot properties), runtime verification (cache regions initialized, statistics enabled, memory allocation correct), monitoring endpoint accessibility (Actuator /actuator/caches returns expected JSON).

**Coverage:** All 5 cache regions verified via Actuator endpoint, cache statistics show 0 initial values, application starts without errors, Ehcache initialization logged.
    </standards>

    <locations>
- Manual testing: Run backend via `cd backend && ./mvnw spring-boot:run`
- Actuator endpoint: http://localhost:8080/actuator/caches
- Application logs: Console output showing Ehcache initialization
- JMX monitoring: JConsole connection to local Spring Boot process
    </locations>

    <ideas>
**Test Idea 1 (Manual - AC5):** Verify Application Startup with Cache Configuration
- Start Spring Boot application: `cd backend && ./mvnw spring-boot:run`
- Check console logs for Ehcache initialization messages containing all 5 cache region names
- Verify no errors or warnings during cache setup
- Expected: Application starts successfully, logs show "Ehcache CacheManager initialized" and lists userCache, sessionCache, tenantCache, propertyCache, lookupCache

**Test Idea 2 (Manual - AC3, AC5):** Verify Actuator Cache Endpoint Accessibility
- Access endpoint: `curl http://localhost:8080/actuator/caches`
- Verify JSON response contains cacheManagers section with cacheManager containing 5 caches
- Verify each cache shows target as "org.ehcache.jsr107.Eh107Cache"
- Expected: HTTP 200 response with JSON listing all 5 configured cache regions

**Test Idea 3 (Manual - AC2, AC5):** Verify Cache Statistics Initial State
- Access metrics endpoint: `curl http://localhost:8080/actuator/metrics/cache.gets?tag=cache:userCache`
- Verify cache shows 0 hits, 0 misses, 0 size initially
- Repeat for other cache regions (sessionCache, tenantCache, propertyCache, lookupCache)
- Expected: All caches show zero statistics before any service methods are called

**Test Idea 4 (Manual - AC3):** Verify JMX Monitoring via JConsole
- Start JConsole: `jconsole` (comes with JDK)
- Connect to local Spring Boot process
- Navigate to: MBeans → org.ehcache → CacheManager → caches
- Verify all 5 cache regions are listed with statistics (Size, Hits, Misses, HitPercentage)
- Expected: JMX tree shows all 5 caches with zero statistics

**Test Idea 5 (Manual - AC2):** Verify ehcache.xml Configuration
- Open backend/src/main/resources/ehcache.xml
- Verify heap allocation set to 100 MB
- Verify userCache: 1000 entries, 30 min TTL
- Verify sessionCache: 5000 entries, 24 hour TTL
- Verify tenantCache: 2000 entries, 1 hour TTL
- Verify propertyCache: 500 entries, 2 hour TTL
- Verify lookupCache: 10000 entries, 12 hour TTL
- Verify statistics enabled: enable-statistics="true"
- Expected: XML validates against Ehcache 3.10 schema, all configurations match Tech Spec

**Test Idea 6 (Manual - AC1):** Verify Spring Cache Configuration
- Open backend/src/main/resources/application-dev.yml
- Verify spring.cache.type=jcache is present
- Verify spring.cache.jcache.config=classpath:ehcache.xml is present
- Open backend/src/main/java/com/ultrabms/UltraBmsApplication.java
- Verify @EnableCaching annotation is present on class
- Expected: Configuration files contain all required cache properties

**Test Idea 7 (Manual - AC4):** Verify README Documentation
- Open README.md
- Locate "Caching Setup" section after "Database Setup"
- Verify section contains: Ehcache configuration explanation, caching annotation examples (@Cacheable, @CachePut, @CacheEvict), cache key generation strategies, /actuator/caches monitoring guide, JMX monitoring instructions, troubleshooting tips
- Expected: Documentation is clear, complete, and provides working examples
    </ideas>
  </tests>
</story-context>
