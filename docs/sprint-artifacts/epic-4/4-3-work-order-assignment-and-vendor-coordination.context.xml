<?xml version="1.0" encoding="UTF-8"?>
<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>3</storyId>
    <title>Work Order Assignment and Vendor Coordination</title>
    <status>drafted</status>
    <generatedAt>2025-11-25</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic-4/4-3-work-order-assignment-and-vendor-coordination.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>maintenance supervisor</asA>
    <iWant>assign work orders to internal staff or external vendors</iWant>
    <soThat>jobs are distributed efficiently</soThat>
    <tasks>
      - Task 1: Define TypeScript Types, Enums, and Schemas (AC: #19)
      - Task 2: Implement Backend WorkOrderAssignment Entity (AC: #8, #16)
      - Task 3: Implement Backend Assignment API Endpoints (AC: #8, #16, #18)
      - Task 4: Implement Vendor Service Integration (AC: #5, #17)
      - Task 5: Implement Email Notification Templates (AC: #13, #14, #15)
      - Task 6: Create Assignment Dialog Component (AC: #2, #3, #4, #5, #6, #7)
      - Task 7: Implement Assignment Form Submission (AC: #7, #8, #9)
      - Task 8: Add Assignment Button to Work Order Detail Page (AC: #1)
      - Task 9: Implement Reassignment Dialog and Flow (AC: #10)
      - Task 10: Create Assignment History Section (AC: #11)
      - Task 11: Create Unassigned Work Orders Page (AC: #12)
      - Task 12: Update Work Order Detail Page UI (AC: #1, #9)
      - Task 13: Implement Responsive Design and Mobile Optimization (AC: #20)
      - Task 14: Add Accessibility Features (AC: #20)
      - Task 15: Write Unit and Integration Tests (AC: #20)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: Assignment Button and Access Control - Button on work order detail page for PROPERTY_MANAGER/MAINTENANCE_SUPERVISOR roles
    AC2: Assignment Dialog Structure - shadcn Dialog with assignee type, assignee selection, notes, action buttons
    AC3: Assignee Type Selection - Radio group: Internal Staff vs External Vendor
    AC4: Internal Staff Assignee Dropdown - Select users with MAINTENANCE_SUPERVISOR role
    AC5: External Vendor Assignee Dropdown - Select active vendors filtered by work order category
    AC6: Assignment Notes Section - Optional textarea (max 500 chars)
    AC7: Assignment Form Validation and Submission - Zod schema with React Hook Form
    AC8: Assignment Backend Processing - POST /api/v1/work-orders/{id}/assign updates WorkOrder, creates WorkOrderAssignment, sends notification
    AC9: Post-Assignment Flow - Close dialog, show toast, invalidate cache, update UI optimistically
    AC10: Reassignment Flow - Similar dialog with reassignment reason field (required, min 10 chars)
    AC11: Assignment History Tracking - Display all assignments chronologically with details
    AC12: Unassigned Work Orders List View - Page at /property-manager/work-orders/unassigned with DataTable
    AC13: Email Notification to Assignee (Internal Staff) - work-order-assigned-staff.html template
    AC14: Email Notification to Assignee (External Vendor) - work-order-assigned-vendor.html template
    AC15: Reassignment Notification to Previous Assignee - work-order-reassigned.html template
    AC16: Backend API Endpoints - POST assign, POST reassign, GET unassigned, GET assignment-history
    AC17: Vendor Service Integration - GET /api/v1/vendors?status=ACTIVE&amp;serviceCategory={category}
    AC18: Assignment Validation Rules - Status validation, assignee validation, reassignment reason required
    AC19: TypeScript Types and Schemas - WorkOrderAssignment interfaces, AssigneeType enum, Zod schemas
    AC20: Responsive Design and Accessibility - Mobile-first, WCAG 2.1 AA, data-testid attributes
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-4-maintenance-operations.md</path>
        <title>Epic 4: Maintenance Operations</title>
        <section>Story 4.3: Work Order Assignment and Vendor Coordination</section>
        <snippet>Manual assignment workflow with assignee type selection (Internal Staff or External Vendor). Assignment updates work order status OPEN → ASSIGNED, creates assignment history, sends email notifications with work order details, photos, and access instructions.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>3.4 Maintenance Management Module</section>
        <snippet>Work order system with job assignment algorithms, vendor assignment automation, and real-time status updates. Supports both internal staff and external vendor assignment with performance tracking.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Frontend Implementation Patterns</section>
        <snippet>Component Pattern: Use shadcn/ui Dialog for modals. Form Pattern: React Hook Form with Zod validation. API Client Pattern: Fetch API with React Query for caching and optimistic updates. TypeScript strict mode enabled.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Backend Implementation Patterns</section>
        <snippet>Controller Pattern: @RestController with @PreAuthorize for role-based access. Service Pattern: @Transactional for database operations. Exception Handling: @ControllerAdvice with custom exceptions. Async Processing: @Async for email notifications.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>REST API Conventions</section>
        <snippet>Base URL: /api/v1. Endpoints: Plural nouns, kebab-case. Status codes: 200 OK, 201 Created, 400 Bad Request, 404 Not Found. Consistent response format with success, data, message, timestamp fields.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Email Service</section>
        <snippet>Spring Mail + Gmail API for sending emails. HTML templates in resources/templates/. Asynchronous sending using @Async. Log email status in audit_logs. Mobile-responsive templates with company branding.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/main/java/com/ultrabms/entity/WorkOrder.java</path>
        <kind>entity</kind>
        <symbol>WorkOrder</symbol>
        <lines>1-200</lines>
        <reason>WorkOrder entity already has assignedTo field (UUID) and status field. Assignment will update these fields: assignedTo, status (OPEN → ASSIGNED), assignedDate. Supports polymorphic assignedTo (can reference User or Vendor).</reason>
      </artifact>
      <artifact>
        <path>backend/src/main/java/com/ultrabms/dto/workorders/AssignWorkOrderDto.java</path>
        <kind>dto</kind>
        <symbol>AssignWorkOrderDto</symbol>
        <lines>1-20</lines>
        <reason>Existing DTO for assignment with assignedTo (UUID) and assignmentNotes fields. Needs extension to include assigneeType field for distinguishing internal staff vs external vendor.</reason>
      </artifact>
      <artifact>
        <path>backend/src/main/java/com/ultrabms/controller/WorkOrderController.java</path>
        <kind>controller</kind>
        <symbol>WorkOrderController.assignWorkOrder</symbol>
        <lines>1-25</lines>
        <reason>Existing POST /api/v1/work-orders/{id}/assign endpoint with @PreAuthorize for PROPERTY_MANAGER/MAINTENANCE_SUPERVISOR roles. Calls workOrderService.assignWorkOrder(). Needs extension for reassignment and unassigned endpoints.</reason>
      </artifact>
      <artifact>
        <path>backend/src/main/java/com/ultrabms/service/impl/WorkOrderServiceImpl.java</path>
        <kind>service</kind>
        <symbol>WorkOrderServiceImpl.assignWorkOrder</symbol>
        <lines>1-35</lines>
        <reason>Existing assignment logic validates work order exists, updates status to ASSIGNED, sets assignedTo and assignedDate, creates WorkOrderComment. Needs extension to create WorkOrderAssignment entity, validate assignee type, send email notifications.</reason>
      </artifact>
      <artifact>
        <path>backend/src/main/java/com/ultrabms/controller/WorkOrderController.java</path>
        <kind>controller</kind>
        <symbol>WorkOrderController.getUnassignedWorkOrders</symbol>
        <lines>1-25</lines>
        <reason>Existing GET /api/v1/work-orders/unassigned endpoint returns paginated list of unassigned work orders (status = OPEN, assignedTo = null). Supports propertyId filter and pagination.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/properties/UnitFormModal.tsx</path>
        <kind>component</kind>
        <symbol>UnitFormModal</symbol>
        <lines>1-200</lines>
        <reason>Reference pattern for shadcn Dialog with React Hook Form + Zod validation. Shows dialog structure, form submission with loading state, toast notifications, and form reset on success.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/components/properties/BulkUnitCreateModal.tsx</path>
        <kind>component</kind>
        <symbol>BulkUnitCreateModal</symbol>
        <lines>1-250</lines>
        <reason>Reference pattern for complex dialog with multiple sections, progress tracking, confirmation dialog, and error handling. Shows how to handle async operations with progress updates.</reason>
      </artifact>
      <artifact>
        <path>frontend/src/lib/validations/maintenance.ts</path>
        <kind>validation</kind>
        <symbol>createMaintenanceRequestSchema</symbol>
        <lines>79-130</lines>
        <reason>Reference pattern for Zod validation schemas with field validation rules, error messages, and type inference. Shows how to define required fields, min/max lengths, and custom validation.</reason>
      </artifact>
      <artifact>
        <path>backend/src/main/resources/templates/email/maintenance-request-status-change.txt</path>
        <kind>template</kind>
        <symbol>maintenance-request-status-change.txt</symbol>
        <lines>1-48</lines>
        <reason>Reference pattern for email templates with Thymeleaf syntax, conditional sections, and dynamic content. Shows how to structure notification emails with work details, vendor info, and action items.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>react-hook-form</package>
        <version>^7.66.0</version>
      </node>
      <node>
        <package>@hookform/resolvers</package>
        <version>^5.2.2</version>
      </node>
      <node>
        <package>zod</package>
        <version>latest</version>
      </node>
      <node>
        <package>@radix-ui/react-dialog</package>
        <version>^1.1.4</version>
      </node>
      <node>
        <package>@radix-ui/react-radio-group</package>
        <version>^1.3.8</version>
      </node>
      <node>
        <package>@radix-ui/react-select</package>
        <version>^2.2.6</version>
      </node>
      <node>
        <package>lucide-react</package>
        <version>^0.553.0</version>
      </node>
      <node>
        <package>@tanstack/react-query</package>
        <version>latest</version>
      </node>
      <node>
        <package>date-fns</package>
        <version>^4.1.0</version>
      </node>
      <java>
        <dependency>spring-boot-starter-mail</dependency>
        <version>3.4.7</version>
      </java>
      <java>
        <dependency>spring-boot-starter-validation</dependency>
        <version>3.4.7</version>
      </java>
      <java>
        <dependency>spring-boot-starter-data-jpa</dependency>
        <version>3.4.7</version>
      </java>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Assignment Rules: Can only assign work orders with status = OPEN, ASSIGNED, or IN_PROGRESS. Cannot assign COMPLETED or CLOSED work orders. Internal staff must have role = MAINTENANCE_SUPERVISOR. External vendors must be ACTIVE and have matching service category. Reassignment requires reason (min 10 chars).</constraint>
    <constraint>Assignee Type Rules: INTERNAL_STAFF assignedTo references User entity. EXTERNAL_VENDOR assignedTo references Vendor entity. Backend validates assignee exists and meets criteria before assigning.</constraint>
    <constraint>Status Progression Rules: OPEN → ASSIGNED (when first assigned). ASSIGNED → ASSIGNED (when reassigned, status doesn't change). Assignment doesn't affect IN_PROGRESS or COMPLETED status.</constraint>
    <constraint>Email Notification Rules: Send to assignee immediately after assignment. Send to previous assignee on reassignment. Include work order details, photos, access instructions. Async sending to avoid blocking API response.</constraint>
    <constraint>Polymorphic Assignment Pattern: assignedTo field in WorkOrder is UUID (can reference User or Vendor). assigneeType field determines which entity assignedTo references. Backend resolves assignee details based on type when returning work order. Frontend displays assignee info with type badge.</constraint>
    <constraint>Assignment History Pattern: Separate WorkOrderAssignment entity tracks all assignments. Each assignment creates new entry (append-only, never update). Supports reassignment tracking with reassignmentReason field. Timeline shows assignment events chronologically.</constraint>
    <constraint>Vendor Integration Pattern: Assignment dialog queries vendor service for active vendors. Filter vendors by service category matching work order category. If vendor service not implemented: disable external vendor option with message. Graceful degradation: internal staff assignment always available.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>POST /api/v1/work-orders/{id}/assign</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/work-orders/{id}/assign
Request Body: { assigneeType: "INTERNAL_STAFF" | "EXTERNAL_VENDOR", assigneeId: UUID, assignmentNotes: string }
Response: { success: true, data: { workOrderId: UUID, assignedTo: { id: UUID, name: string, type: string }, assignedDate: timestamp } }</signature>
      <path>backend/src/main/java/com/ultrabms/controller/WorkOrderController.java</path>
    </interface>
    <interface>
      <name>POST /api/v1/work-orders/{id}/reassign</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/work-orders/{id}/reassign
Request Body: { newAssigneeType: string, newAssigneeId: UUID, reassignmentReason: string, assignmentNotes: string }
Response: { success: true, data: { workOrderId: UUID, previousAssignee: object, newAssignee: object, reassignedDate: timestamp } }</signature>
      <path>backend/src/main/java/com/ultrabms/controller/WorkOrderController.java</path>
    </interface>
    <interface>
      <name>GET /api/v1/work-orders/unassigned</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/work-orders/unassigned?propertyId={uuid}&amp;page=0&amp;size=20
Response: { success: true, data: { workOrders: [], totalPages: number, totalElements: number } }</signature>
      <path>backend/src/main/java/com/ultrabms/controller/WorkOrderController.java</path>
    </interface>
    <interface>
      <name>GET /api/v1/work-orders/{id}/assignment-history</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/work-orders/{id}/assignment-history?page=0&amp;size=20
Response: { success: true, data: { assignments: [{ id, assigneeType, assigneeId, assigneeName, assignedBy, assignedByName, assignedDate, reassignmentReason, assignmentNotes }], totalElements: number } }</signature>
      <path>backend/src/main/java/com/ultrabms/controller/WorkOrderController.java</path>
    </interface>
    <interface>
      <name>GET /api/v1/vendors</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/v1/vendors?status=ACTIVE&amp;serviceCategory={category}
Response: { success: true, data: [{ id: UUID, companyName: string, serviceCategories: [], rating: number, contactPerson: { name, email, phone }, status: string }] }</signature>
      <path>backend/src/main/java/com/ultrabms/controller/VendorController.java</path>
    </interface>
    <interface>
      <name>WorkOrderAssignment</name>
      <kind>TypeScript interface</kind>
      <signature>interface WorkOrderAssignment {
  id: UUID;
  workOrderId: UUID;
  assigneeType: "INTERNAL_STAFF" | "EXTERNAL_VENDOR";
  assigneeId: UUID;
  assigneeName: string;
  assignedBy: UUID;
  assignedByName: string;
  assignedDate: Date;
  reassignmentReason?: string;
  assignmentNotes?: string;
}</signature>
      <path>frontend/src/types/work-order-assignment.ts</path>
    </interface>
    <interface>
      <name>assignWorkOrderSchema</name>
      <kind>Zod schema</kind>
      <signature>const assignWorkOrderSchema = z.object({
  assigneeType: z.enum(["INTERNAL_STAFF", "EXTERNAL_VENDOR"]),
  assigneeId: z.string().uuid(),
  assignmentNotes: z.string().max(500).optional()
})</signature>
      <path>frontend/src/lib/validations/work-order-assignment.ts</path>
    </interface>
    <interface>
      <name>reassignWorkOrderSchema</name>
      <kind>Zod schema</kind>
      <signature>const reassignWorkOrderSchema = z.object({
  newAssigneeType: z.enum(["INTERNAL_STAFF", "EXTERNAL_VENDOR"]),
  newAssigneeId: z.string().uuid(),
  reassignmentReason: z.string().min(10).max(200),
  assignmentNotes: z.string().max(500).optional()
})</signature>
      <path>frontend/src/lib/validations/work-order-assignment.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      ALL interactive elements MUST have data-testid attributes following convention: {component}-{element}-{action}. Examples: btn-assign-work-order, dialog-assign-work-order, radio-assignee-type, select-internal-staff, select-external-vendor, textarea-assignment-notes, btn-submit-assignment. Servers must be verified running before E2E tests (scripts/check-services.sh). Mandatory for buttons, inputs, selects, textareas, dialogs, table rows. Verified in code review before PR approval. Completion notes must include: files created/modified, dependencies, test results. Achieve ≥ 80% code coverage for new code.
    </standards>
    <locations>
      backend/src/test/java/com/ultrabms/service/WorkOrderServiceTest.java
      backend/src/test/java/com/ultrabms/controller/WorkOrderControllerTest.java
      frontend/src/components/work-orders/__tests__/AssignmentDialog.test.tsx
      frontend/src/components/work-orders/__tests__/ReassignmentDialog.test.tsx
      frontend/src/components/work-orders/__tests__/AssignmentHistoryTable.test.tsx
    </locations>
    <ideas>
      <idea ac="AC1">Test assignment button visibility based on user role (PROPERTY_MANAGER, MAINTENANCE_SUPERVISOR). Test button disabled when status = COMPLETED or CLOSED. Test "Assign" vs "Reassign" button display based on assignedTo field.</idea>
      <idea ac="AC2">Test dialog opens on button click. Test dialog structure with all sections present. Test dialog closes on Escape or outside click. Test dialog close button functionality.</idea>
      <idea ac="AC3">Test assignee type radio group with 2 options. Test default selection (INTERNAL_STAFF). Test switching between options updates assignee dropdown.</idea>
      <idea ac="AC4">Test internal staff dropdown populated with MAINTENANCE_SUPERVISOR users. Test empty state message. Test async loading with skeleton. Test search/filter functionality.</idea>
      <idea ac="AC5">Test external vendor dropdown populated with active vendors filtered by category. Test vendor filtering by service category. Test empty state message. Test async loading.</idea>
      <idea ac="AC6">Test assignment notes textarea with character counter. Test max 500 chars validation. Test optional field (can submit without notes).</idea>
      <idea ac="AC7">Test form validation: assigneeType required, assigneeId required, assignmentNotes max 500 chars. Test submit button disabled when form invalid. Test error messages display.</idea>
      <idea ac="AC8">Test backend assignment logic: validates work order status, validates assignee exists, updates WorkOrder fields, creates WorkOrderAssignment entry, creates timeline entry, sends email notification.</idea>
      <idea ac="AC9">Test post-assignment flow: dialog closes, success toast shown, React Query cache invalidated, UI updated optimistically. Test error handling: toast shown, dialog stays open.</idea>
      <idea ac="AC10">Test reassignment dialog with current assignee info banner. Test reassignment reason field required (min 10 chars). Test notifications sent to both previous and new assignees.</idea>
      <idea ac="AC11">Test assignment history table displays all assignments chronologically. Test "Initial Assignment" vs "Reassignment" badges. Test empty state. Test collapsible section.</idea>
      <idea ac="AC12">Test unassigned work orders page displays only OPEN status with assignedTo = null. Test filters (priority, category, property). Test search. Test quick assign button. Test empty state.</idea>
      <idea ac="AC13">Test email notification to internal staff contains: work order details, property/unit info, issue description, photos, access instructions, assignment notes, action button.</idea>
      <idea ac="AC14">Test email notification to external vendor contains: work order details, property address, issue description, photos, access instructions, contact info, PDF attachment.</idea>
      <idea ac="AC15">Test reassignment notification to previous assignee contains: reassignment reason, new assignee name, work order details for reference.</idea>
      <idea ac="AC16">Test all backend API endpoints: POST assign, POST reassign, GET unassigned, GET assignment-history. Test authorization (@PreAuthorize). Test pagination. Test filters.</idea>
      <idea ac="AC17">Test vendor service integration: GET vendors filtered by status=ACTIVE and serviceCategory. Test placeholder message when vendor service not implemented.</idea>
      <idea ac="AC18">Test assignment validation rules: work order status validation, assignee exists validation, assignee active validation, service category matching, reassignment reason min length.</idea>
      <idea ac="AC19">Test TypeScript types and schemas compile without errors. Test Zod validation schemas with valid and invalid data. Test type inference from schemas.</idea>
      <idea ac="AC20">Test responsive design on mobile (375px), tablet (768px), desktop (1440px). Test keyboard navigation (Tab, Enter, Escape). Test ARIA labels and screen reader announcements. Test color contrast ≥ 4.5:1.</idea>
    </ideas>
  </tests>
</story-context>
